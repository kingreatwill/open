<!-- toc -->
[TOC]

High Performance Go Workshopï¼ˆPart3ï¼‰
===================================

### 3\. æ€§èƒ½è¯„ä¼°å’Œåˆ†æ

  

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¯¹å•ä¸ªå‡½æ•°è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿™å¯¹ä½ æå‰çŸ¥é“ç“¶é¢ˆåœ¨å“ªé‡Œå¾ˆæœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œé€šå¸¸ä½ ä¼šæ€€ç–‘äººç”Ÿï¼š

  

> ä¸ºä»€ä¹ˆè¯¥ç¨‹åºéœ€è¦è¿™ä¹ˆé•¿æ—¶é—´æ‰èƒ½è¿è¡Œï¼Ÿ

  

åˆ†ææ•´ä¸ªç¨‹åºï¼Œè¿™å¯¹äºå›ç­”è¯¸å¦‚æ­¤ç±»çš„é«˜çº§é—®é¢˜å¾ˆæœ‰ç”¨ã€‚åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Goå†…ç½®çš„æ€§èƒ½åˆ†æå·¥å…·ä»å†…éƒ¨è°ƒæŸ¥ç¨‹åºçš„è¿è¡Œæƒ…å†µã€‚

  

  

### 3.1. pprof

  

ä»Šå¤©æˆ‘ä»¬è¦è°ˆè®ºçš„ç¬¬ä¸€ä¸ªå·¥å…·æ˜¯ pprofã€‚ [pprof](https://github.com/google/pprof) æºè‡ª [Google Perf Tools](https://github.com/gperftools/gperftools) å·¥å…·å¥—ä»¶ï¼Œè‡ªæœ€æ—©çš„å…¬å¼€å‘å¸ƒä»¥æ¥å°±å·²é›†æˆåˆ°Go runtimeä¸­ã€‚

  

`pprof` åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š

  

*   æ¯ä¸ª Go ç¨‹åºéƒ½å†…ç½®äº† runtime/pprof åŒ…

  

*   go tool pprof æ£€æŸ¥é…ç½®æ–‡ä»¶ã€‚

  

### 3.2. é…ç½®æ–‡ä»¶ç±»å‹

  

pprof æ”¯æŒå¤šç§ç±»å‹çš„åˆ†æï¼Œä»Šå¤©æˆ‘ä»¬å°†è®¨è®ºå…¶ä¸­çš„ä¸‰ç§ï¼š

  

  

*   CPU æ€§èƒ½åˆ†æ  
    

  

*   å†…å­˜æ€§èƒ½åˆ†æ

  

*   é˜»å¡æ€§èƒ½åˆ†æ  
    

  

*   äº’æ–¥æ€§èƒ½åˆ†æ

  

#### 3.2.1. CPU æ€§èƒ½åˆ†æ

  

CPU æ€§èƒ½åˆ†ææ˜¯æœ€å¸¸è§çš„æ€§èƒ½åˆ†æï¼Œä¹Ÿæ˜¯æœ€æ˜æ˜¾çš„ã€‚

  

å¯ç”¨ CPU æ€§èƒ½åˆ†æåï¼Œè¿è¡Œæ—¶å°†æ¯ 10 æ¯«ç§’ä¸­æ–­ä¸€æ¬¡ï¼Œå¹¶è®°å½•å½“å‰æ­£åœ¨è¿è¡Œçš„ goroutine çš„å †æ ˆè·Ÿè¸ªã€‚

  

åˆ†æå®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œåˆ†æï¼Œä»¥ç¡®å®šæœ€éœ€è¦åˆ†æçš„ä»£ç æ¨¡å—ã€‚

  

å‡½æ•°åœ¨æ€§èƒ½åˆ†æä¸­å‡ºç°çš„æ¬¡æ•°è¶Šå¤šï¼Œä»£ç æ¨¡å—å æ€»è¿è¡Œæ—¶ç™¾åˆ†æ¯”çš„æ—¶é—´å°±è¶Šå¤šã€‚

  

  

#### 3.2.2. å†…å­˜æ€§èƒ½åˆ†æ

  

å†…å­˜åˆ†æè®°å½•åœ¨å †åˆ†é…æ—¶è®°å½•å †æ ˆè·Ÿè¸ªã€‚

  

å‡å®šå †æ ˆåˆ†é…æ˜¯ç©ºé—²çš„ï¼Œå¹¶ä¸”åœ¨å†…å­˜åˆ†ææ–‡ä»¶ä¸­æœªè·Ÿè¸ªã€‚

  

å†…å­˜åˆ†æï¼Œå’Œ CPU åˆ†æä¸€æ ·ä¹Ÿæ˜¯åŸºäºæ ·æœ¬çš„ï¼Œæ¯ 1000 ä¸ªåˆ†é…ä¸­çš„å†…å­˜åˆ†ææ ·æœ¬ä¸º1ã€‚è¿™ä¸ªæ¯”ç‡å¯ä»¥æ”¹å˜ã€‚

  

å› ä¸ºå†…å­˜åˆ†ææ˜¯åŸºäºæ ·æœ¬çš„ï¼Œå› ä¸ºå®ƒè·Ÿè¸ªä¸ä½¿ç”¨çš„åˆ†é…ï¼Œæ‰€ä»¥ä½¿ç”¨å†…å­˜åˆ†ææ¥ç¡®å®šåº”ç”¨ç¨‹åºçš„æ€»å†…å­˜ä½¿ç”¨æ˜¯å›°éš¾çš„ã€‚

  

_ä¸ªäººè§‚ç‚¹_ï¼šæˆ‘ä¸è®¤ä¸ºå†…å­˜åˆ†ææœ‰åŠ©äºå‘ç°å†…å­˜æ³„æ¼ã€‚æœ‰æ›´å¥½çš„æ–¹æ³•æ¥ç¡®å®šä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨äº†å¤šå°‘å†…å­˜ã€‚ç¨åæˆ‘ä»¬å°†åœ¨ PPT ä¸­è®¨è®ºè¿™äº›é—®é¢˜ã€‚

  

#### 3.2.3. é˜»å¡åˆ†æ

  

é˜»å¡åˆ†æåœ¨ Go ä¸­æ˜¯éå¸¸ç‹¬ç‰¹çš„ã€‚

  

é˜»å¡åˆ†æå’Œ CPU åˆ†æå¾ˆåƒï¼Œä½†å®ƒè®°å½• goroutineÂ èŠ±åœ¨ç­‰å¾…å…±äº«èµ„æºä¸Šçš„æ—¶é—´ã€‚

  

è¿™å¯¹äºç¡®å®šåº”ç”¨ç¨‹åºä¸­çš„å¹¶å‘ç“¶é¢ˆå¯èƒ½æ˜¯æœ‰ç”¨çš„ã€‚

  

é˜»å¡åˆ†æå¯ä»¥æ˜¾ç¤ºå¤§é‡ goroutine ä½•æ—¶å¯ä»¥å–å¾—ç»“æœï¼Œé˜»å¡ã€‚é˜»å¡åŒ…æ‹¬ï¼š

  

*   åœ¨æœªç¼“å†²ä¿¡é“ä¸Šå‘é€æˆ–æ¥æ”¶ã€‚

  

*   å‘é€æ•°æ®åˆ°ä¸€ä¸ªæ»¡äº†çš„ä¿¡é“ï¼Œä»ä¸€ä¸ªç©ºçš„ä¿¡é“æ¥æ”¶æ•°æ®ã€‚

  

*   è¯•å›¾ç»™å¦ä¸€ä¸ª goroutine é”ä½çš„ sync.mutex çš„ä¸Šé”ã€‚

  

é˜»å¡åˆ†ææ˜¯ä¸€ç§éå¸¸ä¸“ä¸šçš„å·¥å…·ï¼Œåœ¨ä½ ç¡®ä¿¡å·²ç»æ¶ˆé™¤äº†æ‰€æœ‰ CPU å’Œå†…å­˜ä½¿ç”¨ç“¶é¢ˆä¹‹å‰ï¼Œä¸åº”è¯¥ä½¿ç”¨å®ƒã€‚

  

#### 3.2.4. äº’æ–¥æ€§èƒ½åˆ†æ

  

äº’æ–¥é”åˆ†æä¸é˜»å¡åˆ†æç±»ä¼¼ï¼Œä½†åªä¸“é—¨é’ˆå¯¹å¯¼è‡´äº’æ–¥é”äº‰ç”¨å¯¼è‡´å»¶è¿Ÿçš„æ“ä½œä¸Šã€‚

  

æˆ‘å¯¹è¿™ç§ç±»å‹çš„åˆ†ææ²¡æœ‰å¾ˆå¤šç»éªŒï¼Œä½†æ˜¯æˆ‘æäº†ä¸ª PPT æ¥æ¼”ç¤ºå®ƒã€‚æˆ‘ä»¬å°†å¾ˆå¿«çœ‹åˆ°è¯¥ç¤ºä¾‹ã€‚

  

  

  

### 3.3. ä¸€æ¬¡åªæœ‰ä¸€ä¸ªåˆ†æ

  

æ€§èƒ½åˆ†æä¸æ˜¯å…è´¹çš„ã€‚

  

åˆ†æå¯¹ç¨‹åºæ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ï¼Œç‰¹åˆ«æ˜¯å¦‚æœå¢åŠ åˆ†æçš„é‡‡æ ·ç‡ã€‚

  

å¤§å¤šæ•°å·¥å…·ä¸ä¼šé˜»æ­¢ä½ åŒæ—¶å¯ç”¨å¤šä¸ªåˆ†æã€‚

  

> ä¸€æ¬¡ä¸è¦å¯ç”¨å¤šæ¬¡åˆ†æã€‚
> 
>   
> 
> å¦‚æœä½ åŒæ—¶å¯ç”¨å¤šä¸ªåˆ†æï¼Œä»–ä»¬å°†è§‚å¯Ÿè‡ªå·±çš„ç›¸äº’ä½œç”¨å¹¶æŠ›å‡ºä½ çš„ç»“æœã€‚

  

### 3.4. æ”¶é›†åˆ†æ
 

Go è¿è¡Œæ—¶çš„åˆ†ææ¥å£å­˜åœ¨äº runtime/pprof åŒ…ä¸­ã€‚runtime/pprof æ˜¯éå¸¸ä½çº§åˆ«çš„å·¥å…·ï¼Œç”±äºå†å²åŸå› ï¼Œä¸åŒç±»å‹çš„åˆ†æçš„æ¥å£ä¸ç»Ÿä¸€ã€‚

  

æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­çœ‹åˆ°çš„ï¼Œpprof profiling æ˜¯åœ¨ `testing`åŒ…ä¸­æ„å»ºçš„ï¼Œä½†æœ‰æ—¶å®ƒä¸æ–¹ä¾¿ï¼Œæˆ–è€…å¾ˆéš¾ï¼Œå°†è¦åˆ†æçš„ä»£ç æ”¾åœ¨ testing.B åŸºå‡†æµ‹è¯•çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¿…é¡»ç›´æ¥ä½¿ç”¨è¿è¡Œruntime/pprof APIã€‚

  

å‡ å¹´å‰ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªÂ [small package][0]ï¼Œä»¥ä¾¿æ›´å®¹æ˜“åœ°å¯¹ç°æœ‰åº”ç”¨ç¨‹åºè¿›è¡Œåˆ†æã€‚

  
```golang
import "github.com/pkg/profile" 
func main() {  
    defer profile.Start().Stop() 
    // ... 
}
```

  

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ profile åŒ…ã€‚æ™šäº›æ—¶å€™ï¼Œæˆ‘ä»¬å°†ç›´æ¥ä½¿ç”¨ runtime/pprof æ¥å£ã€‚

  

### 3.5. ä½¿ç”¨ pprof åˆ†æ

  

æ—¢ç„¶æˆ‘ä»¬å·²ç»è®¨è®ºäº† pprof å¯ä»¥æµ‹è¯•äº›ä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬è®¨è®ºä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ pprof æ¥åˆ†ææŠ¥å‘Šã€‚

  

åˆ†æç”± go pprof å‘½ä»¤é©±åŠ¨

  
```
go tool pprof /path/to/your/profile
```
  

è¯¥å·¥å…·æä¾›äº†åˆ†ææ•°æ®çš„å‡ ç§ä¸åŒè¡¨ç°å½¢å¼ï¼šæ–‡æœ¬ã€å›¾å½¢ã€ç”šè‡³ç«ç„°å›¾ã€‚

  

> å¦‚æœä½ ä½¿ç”¨ Go å·²æœ‰ä¸€æ®µæ—¶é—´ï¼Œå¯èƒ½çŸ¥é“ `pprof`æœ‰ä¸¤ä¸ªå‚æ•°ã€‚ä» Go 1.9 å¼€å§‹ï¼Œåˆ†æåŒ…å«æ¸²æŸ“é…ç½®æ–‡ä»¶æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚ä½ ä¸å†éœ€è¦ç”Ÿæˆåˆ†æçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ ğŸ‰

  

#### 3.5.1. è¿›ä¸€æ­¥é˜…è¯»

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â   

*   [Profiling Go programs](http://blog.golang.org/profiling-go-programs)(Go Blog)  
    
*   [Debugging performance issues in Go programs](https://software.intel.com/en-us/blogs/2014/05/10/debugging-performance-issues-in-go-programs)

  

#### 3.5.2. CPU åˆ†æ ï¼ˆå®è·µï¼‰

  

è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè®¡ç®—å•è¯æ•°çš„ç¨‹åºï¼š

  
```golang
package main 
import (  
    "fmt" 
    "io" 
    "log" 
    "os" 
    "unicode" 
    "github.com/pkg/profile" 
)   
func readbyte(r io.Reader) (rune, error) {  
    var buf [1]byte 
    _, err := r.Read(buf\[:\]) 
    return rune(buf\[0\]), err 
}   
func main() {  
    defer profile.Start().Stop()  
    f, err := os.Open(os.Args[1]) 
    if err != nil { 
        log.Fatalf("could not open file %q: %v", os.Args\[1\], err) 
    }  
    words := 0 
    inword := false  
    for { 
        r, err := readbyte(f) 
        if err == io.EOF { 
            break 
        } 
        if err != nil { 
            log.Fatalf("could not read file %q: %v", os.Args[1], err) 
        } 
        if unicode.IsSpace(r) && inword { 
            words++ 
            inword = false 
        } 
        inword = unicode.IsLetter(r) 
    } 
    fmt.Printf("%q: %d words\n", os.Args[1], words) 
}
```
  

è®©æˆ‘ä»¬çœ‹çœ‹ Herman Melville çš„ç»å…¸  [Moby Dick](https://www.gutenberg.org/ebooks/2701)

  
```
% go build && time ./words moby.txt 
"moby.txt": 181275 words   
real    0m2.110s 
user    0m1.264s 
sys     0m0.944s
```
  

  

è®©æˆ‘ä»¬å°†å…¶ä¸ unix çš„ wc -w è¿›è¡Œæ¯”è¾ƒ

  
```
% time wc -w moby.txt 
215829 moby.txt   
real    0m0.012s 
user    0m0.009s 
sys     0m0.002s
```
  

  

ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚wc å¤§çº¦é«˜å‡º 19%ï¼Œå› ä¸ºå®ƒæ‰€è€ƒè™‘çš„å•è¯ä¸æˆ‘çš„ç®€å•ç¨‹åºæ‰€åšçš„ä¸åŒã€‚è¿™å¹¶ä¸é‡è¦â€”â€”ä¸¤ä¸ªç¨‹åºéƒ½å°†æ•´ä¸ªæ–‡ä»¶ä½œä¸ºè¾“å…¥ï¼Œå¹¶åœ¨ä¸€æ¬¡ä¼ é€’ä¸­è®¡ç®—ä»å•è¯åˆ°éå•è¯çš„è½¬æ¢æ¬¡æ•°ã€‚

  

è®©æˆ‘ä»¬ç ”ç©¶ä¸ºä»€ä¹ˆä½¿ç”¨ pprof  è¿™äº›ç¨‹åºæœ‰ä¸åŒçš„è¿è¡Œæ—¶é—´ã€‚

  

#### 3.5.3.Â  æ·»åŠ CPUåˆ†æ

  

é¦–å…ˆï¼Œç¼–è¾‘ main.go å¹¶å¯ç”¨åˆ†æ

  
```golang
import (  
    "github.com/pkg/profile" 
)   
func main() {  
    defer profile.Start().Stop() 
    // ...
```
  

ç°åœ¨ï¼Œå½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ª cpu.pprof æ–‡ä»¶

  
```
% go run main.go moby.txt 
2018/08/25 14:09:01 profile: cpu profiling enabled, /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile239941020/cpu.pprof 
"moby.txt": 181275 words 
2018/08/25 14:09:03 profile: cpu profiling disabled, /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile239941020/cpu.pprof
```
  

  

ç°åœ¨æˆ‘ä»¬æœ‰äº†åˆ†ææ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ go tool pprof å»åˆ†æ

  
```
% go tool pprof /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile239941020/cpu.pprof 
Type: cpu 
Time: Aug 25, 2018 at 2:09pm (AEST) 
Duration: 2.05s, Total samples = 1.36s (66.29%) 
Entering interactive mode (type "help" for commands, "o" for options) 
(pprof) top 
Showing nodes accounting for 1.42s, 100% of 1.42s total  
flat  flat%   sum%        cum   cum% 
1.41s 99.30% 99.30%      1.41s 99.30%  syscall.Syscall 
0.01s   0.7%   100%      1.42s   100%  main.readbyte 
0     0%   100%      1.41s 99.30%  internal/poll.(*FD).Read 
0     0%   100%      1.42s   100%  main.main 
0     0%   100%      1.41s 99.30%  os.(*File).Read 
0     0%   100%      1.41s 99.30%  os.(*File).read 
0     0%   100%      1.42s   100%  runtime.main 
0     0%   100%      1.41s 99.30%  syscall.Read 
0     0%   100%      1.41s 99.30%  syscall.read
```
  

  

`top` å‘½ä»¤æ˜¯ä½ å°†ä½¿ç”¨æœ€å¤šçš„å‘½ä»¤ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤ç¨‹åºåœ¨ syscall.Syscall ä¸ŠèŠ±è´¹çš„æ—¶é—´æœ‰ 99%ã€‚ä»¥åŠä¸€å°éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ main.readbyte ã€‚

  

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ `web`å‘½ä»¤å¯è§†åŒ–æ­¤è°ƒç”¨ã€‚è¿™å°†ä»é…ç½®æ–‡ä»¶æ•°æ®ç”Ÿæˆå®šå‘å›¾å½¢ã€‚å›¾åƒå¼•æ“ä½¿ç”¨æ¥è‡ª Graphviz çš„ `dot`å‘½ä»¤ã€‚

  

ä½†æ˜¯ï¼Œåœ¨ Go 1.10ï¼ˆå¯èƒ½æ˜¯ 1.11ï¼‰ä¸­ï¼ŒGo é™„å¸¦äº†æœ¬åœ°æ”¯æŒ http æœåŠ¡å™¨çš„ pprof ç‰ˆæœ¬ã€‚

  
```
% go tool pprof -http=:8080 /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile239941020/cpu.pprof
```
  

å°†æ‰“å¼€ç½‘ç»œæµè§ˆå™¨ï¼›

  

*   å›¾å½¢æ¨¡å¼

  

*   ç«ç„°å›¾æ¨¡å¼

  

åœ¨å›¾ä¸­ï¼ŒCPU å¼€é”€æœ€å¤§çš„æ–¹æ¡†æ˜¯ sys call.Syscallï¼Œå ç¨‹åºä¸­èŠ±è´¹çš„æ€»æ—¶é—´çš„ 99.3%ã€‚å¯¼è‡´ syscall.Syscall çš„ä¸€ä¸²å­—ç¬¦ä¸²ä»£è¡¨äº†ç›´æ¥è°ƒç”¨æ–¹-----å¦‚æœå¤šä¸ªä»£ç è·¯å¾„åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸Šæ”¶æ•›ï¼Œåˆ™å¯ä»¥ä¸æ­¢ä¸€ä¸ªã€‚ç®­å¤´çš„å¤§å°è¡¨ç¤ºåœ¨ä¸€ä¸ªæ–¹æ¡†ä¸­çš„å­èŠ‚ç‚¹èŠ±äº†å¤šå°‘æ—¶é—´ï¼Œæˆ‘ä»¬çœ‹åˆ°ä» main.readbyte å¼€å§‹ï¼Œå®ƒä»¬å å›¾è‡‚ä¸­ 1.41 ç§’ï¼Œæ‰€èŠ±è´¹çš„æ—¶é—´è¿‘ 0ã€‚

  

_é—®é¢˜_ï¼šæœ‰äººèƒ½çŒœåˆ°ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ç‰ˆæœ¬æ¯” wc æ…¢å¾—å¤šå—ï¼Ÿ

  

#### 3.5.4. æ”¹è¿›æˆ‘ä»¬çš„ç‰ˆæœ¬

  

æˆ‘ä»¬çš„ç¨‹åºä¹‹æ‰€ä»¥æ…¢ä¸æ˜¯å› ä¸º Go çš„ syscall.Syscall æ…¢ã€‚è¿™æ˜¯å› ä¸º syscalls ä¸€èˆ¬éƒ½æ˜¯å¼€é”€å¾ˆå¤§çš„æ“ä½œï¼ˆè€Œä¸”éšç€ Spectre å®¶æ—è¶Šæ¥è¶Šå¤šçš„æ¼æ´è¢«å‘ç°ï¼Œå¼€é”€æˆæœ¬ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼‰ã€‚

  

æ¯æ¬¡è°ƒç”¨ `readbyte`éƒ½ä¼šå¯¼è‡´ syscall.Readï¼Œç¼“å†²åŒºå¤§å°ä¸º1ã€‚æ‰€ä»¥ç¨‹åºæ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡ç­‰äºè¾“å…¥çš„å¤§å°ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ pprofå›¾ä¸­ï¼Œè¯»å–è¾“å…¥çš„å†…å®¹å ä¸»å¯¼åœ°ä½ã€‚

  
```golang
func main() {  
    defer profile.Start(profile.MemProfile, profile.MemProfileRate(1)).Stop() 
    // defer profile.Start(profile.MemProfile).Stop()  
    f, err := os.Open(os.Args[1]) 
    if err != nil { 
        log.Fatalf("could not open file %q: %v", os.Args[1], err)
    }  
    b := bufio.NewReader(f) 
    words := 0 
    inword := false 
    for { 
        r, err := readbyte(b) 
        if err == io.EOF { break } 
        if err != nil { 
            log.Fatalf("could not read file %q: %v", os.Args[1], err) 
         } 
        if unicode.IsSpace(r) && inword { 
            words++ 
            inword = false 
        } 
        inword = unicode.IsLetter(r) 
    } 
    fmt.Printf("%q: %d words\n", os.Args[1], words) 
}
```
  

  

é€šè¿‡åœ¨è¾“å…¥æ–‡ä»¶å’Œ `readbyte` ä¹‹é—´æ’å…¥ bufio.Reader  

  

å°†ä¿®æ”¹åç¨‹åºçš„æ—¶é—´ä¸ wc è¿›è¡Œæ¯”è¾ƒçœ‹çœ‹ç›¸å·®å¤šè¿œï¼Ÿ æ¥ä¸ªæ€§èƒ½æµ‹è¯•ï¼Œçœ‹çœ‹è¿˜æœ‰ä»€ä¹ˆã€‚

  

#### 3.5.5. å†…å­˜åˆ†æ

  

æ–° `words`  æ€§èƒ½åˆ†æè¡¨æ˜ï¼Œåœ¨ `readbyte`å‡½æ•°å†…åˆ†é…äº†æŸäº›å†…å®¹ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ pprof æ¥è°ƒæŸ¥ã€‚

  
```
defer profile.Start(profile.MemProfile).Stop()
```
  

ç„¶åç…§å¸¸è¿è¡Œç¨‹åº

  
```
% go run main2.go moby.txt 
2018/08/25 14:41:15 profile: memory profiling enabled (rate 4096), /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile312088211/mem.pprof 
"moby.txt": 181275 words 
2018/08/25 14:41:15 profile: memory profiling disabled, /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile312088211/mem.pprof
```

  

 ![å›¾ç‰‡.png](../../img/go/pprof-1.png) 

  

  

æ­£å¦‚æˆ‘ä»¬æ€€ç–‘åˆ†é…æ¥è‡ª `readbyte` - è¿™ä¸æ˜¯é‚£ä¹ˆå¤æ‚ï¼ŒreadbyteÂ æ˜¯ä¸‰è¡Œé•¿ï¼š

  

ä½¿ç”¨ pprof ç¡®å®šåˆ†é…æ¥è‡ªä½•å¤„ã€‚

  
```golang
func readbyte(r io.Reader) (rune, error) {  
    var buf [1]byte 
    _, err := r.Read(buf[:]) 
    return rune(buf[0]), err 
}
```
  

  

1.  åˆ†é…åœ¨ç¬¬2è¡Œ

  

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ›´è¯¦ç»†åœ°è®¨è®ºä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä½†ç›®å‰æˆ‘ä»¬çœ‹åˆ°çš„æ¯ä¸ªå¯¹readbyte çš„è°ƒç”¨éƒ½æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„1å­—èŠ‚é•¿æ•°ç»„ï¼Œå¹¶ä¸”è¯¥æ•°ç»„åœ¨å †ä¸Šåˆ†é…ã€‚

  

æˆ‘ä»¬å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•é¿å…è¿™ç§æƒ…å†µï¼Ÿè¯·å°è¯•ä½¿ç”¨å®ƒä»¬å¹¶ä½¿ç”¨ CPU å’Œå†…å­˜åˆ†ææ¥è¯æ˜è¿™ä¸€ç‚¹ã€‚

  

##### Alloc objects vs. inuse objects

  

å†…å­˜é…ç½®æ–‡ä»¶åˆ†ä¸ºä¸¤ç§ï¼Œ go tool pprof ä¸ºå‘½ä»¤è¡Œå‘½ä»¤

  

  

*   `-alloc_objects`Â æŠ¥å‘Šè¿›è¡Œæ¯ä¸ªåˆ†é…çš„è°ƒç”¨ç«™ç‚¹ã€‚
*   `-inuse_objects`Â æŠ¥å‘Šåœ¨åˆ†ææœ«å°¾å¯åˆ°è¾¾çš„å‘¼å«ç«™ç‚¹ï¼Œå¦‚æœå¯ä»¥è¿›è¡Œåˆ†é…ã€‚

  

ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªäººä¸ºç¨‹åºï¼Œå®ƒå°†ä»¥æ§åˆ¶çš„æ–¹å¼åˆ†é…ä¸€å †å†…å­˜ã€‚

  
```golang
const count = 100000   
var y []byte   
func main() {  
    defer profile.Start(profile.MemProfile, profile.MemProfileRate(1)).Stop() 
    y = allocate() 
    runtime.GC() 
}   
// allocate allocates count byte slices and returns the first slice allocated. 
func allocate() []byte {  
    var x [][]byte 
    for i := 0; i < count; i++ { 
        x = append(x, makeByteSlice()) 
    } 
    return x[0] 
}   
// makeByteSlice returns a byte slice of a random length in the range \[0, 16384). 
func makeByteSlice() []byte {  
    return make([]byte, rand.Intn(2^14)) 
}
```
  

  

è¯¥ç¨‹åºæ˜¯ä½¿ç”¨Â `profile`åŒ…è¿›è¡Œæ³¨é‡Šï¼Œæˆ‘ä»¬å°†å†…å­˜åˆ†æé€Ÿç‡è®¾ç½®ä¸º 1ï¼Œå³è®°å½•æ¯ä¸ªåˆ†é…çš„å †æ ˆè·Ÿè¸ªã€‚è¿™ä¼šå‡æ…¢ç¨‹åºçš„é€Ÿåº¦ï¼Œä½†ä½ ä¸€åˆ†é’Ÿåå°±ä¼šæ˜ç™½åŸå› ã€‚

  
```
% go run main.go 
2018/08/25 15:22:05 profile: memory profiling enabled (rate 1), /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile730812803/mem.pprof 
2018/08/25 15:22:05 profile: memory profiling disabled, /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile730812803/mem.pprof
```
  

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å·²åˆ†é…å¯¹è±¡çš„å›¾ï¼Œè¿™æ˜¯é»˜è®¤å€¼ï¼Œå¹¶æ˜¾ç¤ºå¯¼è‡´åœ¨åˆ†ææœŸé—´åˆ†é…æ¯ä¸ªå¯¹è±¡çš„è°ƒç”¨å›¾ã€‚

  
```
% go tool pprof -http=:8080 /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile891268605/mem.pprof
```
  

 ![image.png](../../img/go/pprof-2.png) 

  

  

æ¯«ä¸å¥‡æ€ªï¼Œè¶…è¿‡99%çš„åˆ†é…æ˜¯åœ¨Â makeByteSliceã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ -inuse_objects æŸ¥çœ‹åŒä¸€åˆ†æã€‚

  
```
% go tool pprof -http=:8080 /var/folders/by/3gf34\_z95zg05cyj744\_vhx40000gn/T/profile891268605/mem.pprof
```
  

  

 ![image.png](../../img/go/pprof-3.png) 

  

æˆ‘ä»¬çœ‹åˆ°çš„ä¸æ˜¯åœ¨åˆ†ææœŸé—´åˆ†é…çš„å¯¹è±¡ï¼Œè€Œæ˜¯åœ¨é‡‡ç”¨åˆ†ææ—¶ä»åœ¨ä½¿ç”¨çš„å¯¹è±¡ ï¼Œ è¿™å¿½ç•¥åƒåœ¾å›æ”¶å™¨å›æ”¶çš„å¯¹è±¡çš„å †æ ˆè·Ÿè¸ªã€‚

  

  

#### 3.5.6. é˜»å¡åˆ†æ

  

æˆ‘ä»¬å°†æŸ¥çœ‹çš„æœ€åä¸€ä¸ªåˆ†æç±»å‹æ˜¯é˜»å¡åˆ†æã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª net/http åŒ…çš„`ClientServer`åŸºå‡†ã€‚

  
```
% go test -run=XXX -bench=ClientServer$ -blockprofile=/tmp/block.p net/http 
% go tool pprof -http=:8080 /tmp/block.p
```
  

 ![image.png](../../img/go/pprof-4.png) 

  

#### 3.5.7. çº¿ç¨‹åˆ›å»ºåˆ†æ

  

Go 1.11 æ·»åŠ äº†å¯¹åˆ†ææ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ›å»ºçš„æ”¯æŒã€‚

  

å‘ `godoc`æ·»åŠ çº¿ç¨‹åˆ›å»ºåˆ†æï¼Œå¹¶è§‚å¯Ÿåˆ†æ godoc -http=:8080 -index Â çš„ç»“æœã€‚

  

  

#### 3.5.8. å¸§æŒ‡é’ˆ

  

Go 1.7 å·²ç»å‘å¸ƒï¼Œå¹¶ä¸”ä¸ amd64 çš„æ–°ç¼–è¯‘å™¨ä¸€èµ·å‘å¸ƒçš„ï¼Œç¼–è¯‘å™¨ç°åœ¨é»˜è®¤å¯ç”¨å¸§æŒ‡é’ˆã€‚

  

å¸§æŒ‡é’ˆæ˜¯å§‹ç»ˆæŒ‡å‘å½“å‰å †æ ˆå¸§é¡¶éƒ¨çš„å¯„å­˜å™¨ã€‚

  

å¸§æŒ‡é’ˆä½¿è¯¸å¦‚ gdb(1)Â å’Œ perf(1)Â  ç­‰å·¥å…·èƒ½å¤Ÿç†è§£ Go è°ƒç”¨å †æ ˆã€‚

  

åœ¨æœ¬ç ”è®¨ä¼šä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šä»‹ç»è¿™äº›å·¥å…·ï¼Œä½†ä½ å¯ä»¥é˜…è¯»å’Œè§‚çœ‹æˆ‘å…³äºä»‹ç» Go ç¨‹åºçš„ä¸ƒç§ä¸åŒæ–¹å¼çš„æ¼”ç¤ºã€‚

  

*   [Seven ways to profile a Go program](https://talks.godoc.org/github.com/davecheney/presentations/seven.slide)(slides)

  

*   [Seven ways to profile a Go program](https://www.youtube.com/watch?v=2h_NFBFrciI)(video, 30 mins)

  

*   [Seven ways to profile a Go program](https://www.bigmarker.com/remote-meetup-go/Seven-ways-to-profile-a-Go-program)Â (webcast, 60 mins)

  

  

#### 3.5.9. ç»ƒä¹ 

  

*   ä»ä½ éå¸¸äº†è§£çš„ä»£ç æ®µç”Ÿæˆåˆ†ææ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰ä»£ç ç¤ºä¾‹ï¼Œè¯·å°è¯•åˆ†æÂ `godoc`.

  
```
% go get golang.org/x/tools/cmd/godoc 
% cd $GOPATH/src/golang.org/x/tools/cmd/godoc
 % vim main.go
```
  

*   å¦‚æœè¦åœ¨ä¸€å°æœºå™¨ä¸Šç”Ÿæˆåˆ†ææ–‡ä»¶å¹¶åœ¨å¦ä¸€å°è®¡ç®—æœºä¸Šæ£€æŸ¥åˆ†ææ–‡ä»¶ï¼Œä½ å°†å¦‚ä½•æ“ä½œï¼Ÿ

 
[TOC]
# ä½¿ç”¨readelfå’Œobjdumpè§£æç›®æ ‡æ–‡ä»¶
## å¼•è¨€
æœ¬æ–‡æ˜¯å¯¹ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ï¼šé“¾æ¥ã€è£…è½½ä¸åº“ä¸­ç¬¬3ç« çš„å®è·µæ€»ç»“(å’Œç»“æ„ç›¸å…³çš„ç¤ºæ„å›¾éƒ½æ˜¯ç”¨Gliffy Diagramsç”»çš„ğŸ¤“)ï¼Œé€šè¿‡ä½¿ç”¨å·¥å…·readelfã€objdumpå¯¹ç›®æ ‡æ–‡ä»¶è¿›è¡Œè§£æï¼Œå­¦ä¹ ç›®æ ‡æ–‡ä»¶çš„ç»“æ„ã€‚

## 1. ç›®æ ‡æ–‡ä»¶
### 1.1 ç›®æ ‡æ–‡ä»¶çš„å®šä¹‰
ç¼–è¯‘å™¨ç¼–è¯‘æºä»£ç åç”Ÿæˆçš„æ–‡ä»¶å«åšç›®æ ‡æ–‡ä»¶ã€‚åœ¨Linuxä¸‹ï¼Œä½¿ç”¨gcc -c xxxx.cç¼–è¯‘ç”Ÿæˆ.oæ–‡ä»¶ã€‚
```c
$ gcc -v simple.c
$ ls
simple.c simeple.o
```
### 1.2 ç¼–è¯‘è¿‡ç¨‹å›é¡¾
![](img/compile-1.webp)
ç›®æ ‡æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ä¸ºELFï¼Œåœ¨Linuxä¸‹å¯¹åº”æ–‡ä»¶åç¼€ä¸º.oçš„æ–‡ä»¶ï¼ŒWindowä¸‹å¯¹åº”æ–‡ä»¶åç¼€ä¸º.objçš„æ–‡ä»¶ã€‚ä½¿ç”¨fileå‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°.oå’Œ.objæ–‡ä»¶å‡ä¸ºELFç±»å‹ã€‚
```
[root@etcd-node02 go]# file go
go: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped
```
ç›®æ ‡æ–‡ä»¶åªæ˜¯ELFæ–‡ä»¶çš„å¯é‡å®šä½æ–‡ä»¶(Relocatable file)ï¼ŒELFæ–‡ä»¶ä¸€å…±æœ‰4ç§ç±»å‹ï¼šRelocatable fileã€Executable fileã€Shared object fileå’Œ[Core Dump file](http://hutaow.com/blog/2013/10/25/linux-core-dump/)
![](img/file-cmd-1.webp)

### ç¤ºä¾‹
åœ¨Linuxä¸‹ï¼Œä½¿ç”¨å‘½ä»¤ gcc -c xxxx.cå°±å¯ä»¥ç¼–è¯‘ç”Ÿæˆ.oæ–‡ä»¶
```
ckt@ubuntu:~/work/elf$ gcc -c simple.c 
ckt@ubuntu:~/work/elf$ ls
simple.c  simple.o
```
åœ¨ simple.cä¸­ï¼Œæˆ‘ä»¬åªåŠ å…¥äº†ä¸‹é¢è¿™ä¸€ä¸ªå‡½æ•°funï¼Œå‡½æ•°å†…å®¹ä¸ºç©º
```
void fun()
{

}
```
ä½¿ç”¨UltraEditå°†simple.oæ‰“å¼€ï¼Œé‡Œé¢çš„å†…å®¹æœ‰æœºå™¨æŒ‡ä»¤ä»£ç ã€æ•°æ®ç­‰ï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±æ˜¯ç”±è¿™äº›å­—èŠ‚ç»„æˆçš„ã€‚å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œä½¿ç”¨é«˜çº§è¯­è¨€(C/C++ï¼ŒJavaç­‰)å®ç°çš„ä»£ç æ˜¯æœ€å®¹æ˜“é˜…è¯»å’Œç†è§£çš„ï¼Œä½†æ˜¯å¯¹äºè®¡ç®—æœºæ¥è¯´ï¼Œå®ƒåªæ‡‚å¾—æœºå™¨è¯­è¨€ï¼Œå®ƒæ›´å–œæ¬¢äºŒè¿›åˆ¶ï¼Œå°†0è½¬æ¢ä¸ºä½ç”µå¹³ï¼Œ1è½¬æ¢æˆé«˜ç”µå¹³ï¼Œè¿™æ ·ä¸€ä¸ªç¨‹åºå°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å…·readelf å’Œobjdumpå¯¹ç›®æ ‡æ–‡ä»¶simple.oè¿›è¡Œåˆ†æã€‚ä¸ºäº†åŠ æ·±å¯¹ç›®æ ‡æ–‡ä»¶çš„ç†è§£ï¼Œåœ¨ä½¿ç”¨readelf & objdumpè¿›è¡Œå‰ï¼Œéœ€è¦å…ˆè¦äº†è§£ELFæ–‡ä»¶çš„ç»“æ„ã€‚
```
00000000h: 7F 45 4C 46 02 01 01 00 00 00 00 00 00 00 00 00 ; ï¿½ELF............
00000010h: 01 00 3E 00 01 00 00 00 00 00 00 00 00 00 00 00 ; ..>.............
00000020h: 00 00 00 00 00 00 00 00 08 01 00 00 00 00 00 00 ; ................
00000030h: 00 00 00 00 40 00 00 00 00 00 40 00 0B 00 08 00 ; ....@.....@.....
00000040h: 55 48 89 E5 5D C3 00 00 00 47 43 43 3A 20 28 55 ; UHå¤Š]?..GCC: (U
00000050h: 62 75 6E 74 75 2F 4C 69 6E 61 72 6F 20 34 2E 36 ; buntu/Linaro 4.6
00000060h: 2E 33 2D 31 75 62 75 6E 74 75 35 29 20 34 2E 36 ; .3-1ubuntu5) 4.6
00000070h: 2E 33 00 00 00 00 00 00 14 00 00 00 00 00 00 00 ; .3..............
00000080h: 01 7A 52 00 01 78 10 01 1B 0C 07 08 90 01 00 00 ; .zR..x......?..
00000090h: 1C 00 00 00 1C 00 00 00 00 00 00 00 06 00 00 00 ; ................
000000a0h: 00 41 0E 10 86 02 43 0D 06 41 0C 07 08 00 00 00 ; .A..?C..A......
000000b0h: 00 2E 73 79 6D 74 61 62 00 2E 73 74 72 74 61 62 ; ..symtab..strtab
000000c0h: 00 2E 73 68 73 74 72 74 61 62 00 2E 74 65 78 74 ; ..shstrtab..text
000000d0h: 00 2E 64 61 74 61 00 2E 62 73 73 00 2E 63 6F 6D ; ..data..bss..com
000000e0h: 6D 65 6E 74 00 2E 6E 6F 74 65 2E 47 4E 55 2D 73 ; ment..note.GNU-s
000000f0h: 74 61 63 6B 00 2E 72 65 6C 61 2E 65 68 5F 66 72 ; tack..rela.eh_fr
00000100h: 61 6D 65 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ame.............
00000110h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000120h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000130h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000140h: 00 00 00 00 00 00 00 00 1B 00 00 00 01 00 00 00 ; ................
00000150h: 06 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000160h: 40 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 ; @...............
00000170h: 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 ; ................
00000180h: 00 00 00 00 00 00 00 00 21 00 00 00 01 00 00 00 ; ........!.......
00000190h: 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000001a0h: 48 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; H...............
000001b0h: 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 ; ................
000001c0h: 00 00 00 00 00 00 00 00 27 00 00 00 08 00 00 00 ; ........'.......
000001d0h: 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000001e0h: 48 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; H...............
000001f0h: 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 ; ................
00000200h: 00 00 00 00 00 00 00 00 2C 00 00 00 01 00 00 00 ; ........,.......
00000210h: 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; 0...............
00000220h: 48 00 00 00 00 00 00 00 2B 00 00 00 00 00 00 00 ; H.......+.......
00000230h: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ; ................
00000240h: 01 00 00 00 00 00 00 00 35 00 00 00 01 00 00 00 ; ........5.......
00000250h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000260h: 73 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; s...............
00000270h: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ; ................
00000280h: 00 00 00 00 00 00 00 00 4A 00 00 00 01 00 00 00 ; ........J.......
00000290h: 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000002a0h: 78 00 00 00 00 00 00 00 38 00 00 00 00 00 00 00 ; x.......8.......
000002b0h: 00 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 ; ................
000002c0h: 00 00 00 00 00 00 00 00 45 00 00 00 04 00 00 00 ; ........E.......
000002d0h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000002e0h: B0 04 00 00 00 00 00 00 18 00 00 00 00 00 00 00 ; ?..............
000002f0h: 09 00 00 00 06 00 00 00 08 00 00 00 00 00 00 00 ; ................
00000300h: 18 00 00 00 00 00 00 00 11 00 00 00 03 00 00 00 ; ................
00000310h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000320h: B0 00 00 00 00 00 00 00 54 00 00 00 00 00 00 00 ; ?......T.......
00000330h: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ; ................
00000340h: 00 00 00 00 00 00 00 00 01 00 00 00 02 00 00 00 ; ................
00000350h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000360h: C8 03 00 00 00 00 00 00 D8 00 00 00 00 00 00 00 ; ?......?......
00000370h: 0A 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 ; ................
00000380h: 18 00 00 00 00 00 00 00 09 00 00 00 03 00 00 00 ; ................
00000390h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000003a0h: A0 04 00 00 00 00 00 00 0E 00 00 00 00 00 00 00 ; ?..............
000003b0h: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ; ................
000003c0h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000003d0h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
000003e0h: 01 00 00 00 04 00 F1 FF 00 00 00 00 00 00 00 00 ; ......?........
000003f0h: 00 00 00 00 00 00 00 00 00 00 00 00 03 00 01 00 ; ................
00000400h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000410h: 00 00 00 00 03 00 02 00 00 00 00 00 00 00 00 00 ; ................
00000420h: 00 00 00 00 00 00 00 00 00 00 00 00 03 00 03 00 ; ................
00000430h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000440h: 00 00 00 00 03 00 05 00 00 00 00 00 00 00 00 00 ; ................
00000450h: 00 00 00 00 00 00 00 00 00 00 00 00 03 00 06 00 ; ................
00000460h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000470h: 00 00 00 00 03 00 04 00 00 00 00 00 00 00 00 00 ; ................
00000480h: 00 00 00 00 00 00 00 00 0A 00 00 00 12 00 01 00 ; ................
00000490h: 00 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00 ; ................
000004a0h: 00 73 69 6D 70 6C 65 2E 63 00 66 75 6E 00 00 00 ; .simple.c.fun...
000004b0h: 20 00 00 00 00 00 00 00 02 00 00 00 02 00 00 00 ;  ...............
000004c0h: 00 00 00 00 00 00 00 00                         ; ........
```
## ELFæ ¼å¼è§„èŒƒ
åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ˜¯ä¸€ç§ç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ã€å¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡ä»£ç ã€å…±äº«åº“å’Œæ ¸å¿ƒè½¬å‚¨æ ¼å¼æ–‡ä»¶ã€‚
**.exe ä¸æ˜¯elfæ–‡ä»¶æ ¼å¼è€Œæ˜¯PEæ–‡ä»¶æ ¼å¼ï¼Œè¦æƒ³æŸ¥çœ‹PEæ–‡ä»¶ ç”¨å¯ä»¥StudyPE+ x64.exeæŸ¥çœ‹**

ç°åœ¨PCå¹³å°æµè¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ˆExecutableï¼‰ä¸»è¦æ˜¯Windowsä¸‹çš„[PEï¼ˆPortable Executableï¼‰](https://www.cnblogs.com/qftm/p/11611038.html)å’ŒLinuxçš„ELFï¼ˆExecutable Linkable Formatï¼‰ï¼Œå®ƒä»¬éƒ½æ˜¯COFFï¼ˆCommon file formatï¼‰æ ¼å¼çš„å˜ç§ã€‚
ä¸å…‰æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆWindowsçš„.exeå’ŒLinuxä¸‹çš„ELFå¯æ‰§è¡Œæ–‡ä»¶ï¼‰æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚åŠ¨æ€é“¾æ¥åº“ï¼ˆDLLï¼ŒDynamic Linking Libraryï¼‰ï¼ˆ`Windowsçš„.dllå’ŒLinuxçš„.so`ï¼‰åŠé™æ€é“¾æ¥åº“ï¼ˆStatic Linking Libraryï¼‰ï¼ˆWindowsçš„.libå’ŒLinuxçš„.aï¼‰æ–‡ä»¶éƒ½æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ã€‚å®ƒä»¬åœ¨Windowsä¸‹éƒ½æŒ‰ç…§PE-COFFæ ¼å¼å­˜å‚¨ï¼ŒLinuxä¸‹æŒ‰ç…§ELFæ ¼å¼å­˜å‚¨ã€‚
ä»€ä¹ˆåˆæ˜¯COFFæ ¼å¼å‘¢ï¼Ÿ
COFFæ˜¯ç”±Unix System V Release 3é¦–å…ˆæå‡ºå¹¶ä¸”ä½¿ç”¨çš„æ ¼å¼è§„èŒƒï¼Œåæ¥å¾®è½¯å…¬å¸åŸºäºCOFFæ ¼å¼ï¼Œåˆ¶å®šäº†PEæ ¼å¼æ ‡å‡†ï¼Œå¹¶å°†å…¶ç”¨äºå½“æ—¶çš„Windows NTç³»ç»Ÿã€‚System V Release 4åœ¨COFFçš„åŸºç¡€ä¸Šå¼•å…¥äº†ELFæ ¼å¼ï¼Œç›®å‰æµè¡Œçš„Linuxç³»ç»Ÿä¹Ÿä»¥ELFä½œä¸ºåŸºæœ¬å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç›®å‰PEå’ŒELFå¦‚æ­¤ç›¸ä¼¼çš„ä¸»è¦åŸå› ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯æºäºåŒä¸€ç§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼COFFã€‚

Unixæœ€æ—©çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸ºa.outæ ¼å¼ï¼Œå®ƒçš„è®¾è®¡éå¸¸åœ°ç®€å•ï¼Œä»¥è‡³äºåæ¥å…±äº«åº“è¿™ä¸ªæ¦‚å¿µå‡ºç°çš„æ—¶å€™ï¼Œa.outæ ¼å¼å°±å˜å¾—æ‰è¥Ÿè§è‚˜äº†ã€‚äºæ˜¯äººä»¬è®¾è®¡äº†COFFæ ¼å¼æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œè¿™ä¸ªè®¾è®¡éå¸¸é€šç”¨ï¼Œä»¥è‡³äºCOFFçš„ç»§æ‰¿è€…åˆ°ç›®å‰è¿˜åœ¨è¢«å¹¿æ³›åœ°ä½¿ç”¨ã€‚

COFFçš„ä¸»è¦è´¡çŒ®æ˜¯åœ¨ç›®æ ‡æ–‡ä»¶é‡Œé¢å¼•å…¥äº†â€œæ®µâ€çš„æœºåˆ¶ï¼Œä¸åŒçš„ç›®æ ‡æ–‡ä»¶å¯ä»¥æ‹¥æœ‰ä¸åŒæ•°é‡åŠä¸åŒç±»å‹çš„â€œæ®µâ€ã€‚å¦å¤–ï¼Œå®ƒè¿˜å®šä¹‰äº†è°ƒè¯•æ•°æ®æ ¼å¼ã€‚

ç›®æ ‡æ–‡ä»¶æœ‰ä¸‰ç§ç±»å‹ï¼š
1. å¯é‡å®šä½æ–‡ä»¶ï¼ˆRelocatable Fileï¼‰ åŒ…å«é€‚åˆäºä¸å…¶ä»–ç›®æ ‡æ–‡ä»¶é“¾æ¥æ¥åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…å…±äº«ç›®æ ‡æ–‡ä»¶çš„ä»£ç å’Œæ•°æ®ã€‚ (Linuxçš„*.o æ–‡ä»¶ Windowsçš„ *.objæ–‡ä»¶)
2. å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆExecutable Fileï¼‰ åŒ…å«é€‚åˆäºæ‰§è¡Œçš„ä¸€ä¸ªç¨‹åºï¼Œæ­¤æ–‡ä»¶è§„å®šäº† exec() å¦‚ä½•åˆ›å»ºä¸€ä¸ªç¨‹åºçš„è¿›ç¨‹æ˜ åƒã€‚ï¼ˆæ¯”å¦‚/bin/bashæ–‡ä»¶ï¼›Windowsçš„*.exeï¼‰
3. å…±äº«ç›®æ ‡æ–‡ä»¶ï¼ˆShared Object Fileï¼‰ åŒ…å«å¯åœ¨ä¸¤ç§ä¸Šä¸‹æ–‡ä¸­é“¾æ¥çš„ä»£ç å’Œæ•°æ®ã€‚é¦–å…ˆé“¾æ¥ç¼–è¾‘å™¨å¯ä»¥å°†å®ƒå’Œå…¶å®ƒå¯é‡å®šä½æ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶ä¸€èµ·å¤„ç†ï¼Œç”Ÿæˆå¦å¤–ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ã€‚å…¶æ¬¡ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰å¯èƒ½å°†å®ƒä¸æŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠå…¶å®ƒå…±äº«ç›®æ ‡ä¸€èµ·ç»„åˆï¼Œåˆ›å»ºè¿›ç¨‹æ˜ åƒã€‚
ç›®æ ‡æ–‡ä»¶å…¨éƒ¨æ˜¯ç¨‹åºçš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œç›®çš„æ˜¯ç›´æ¥åœ¨æŸç§å¤„ç†å™¨ä¸Šç›´æ¥æ‰§è¡Œï¼ˆ`Linuxçš„.soï¼Œå¦‚/lib/ glibc-2.5.so`ï¼›Windowsçš„DLL

### ELFæ–‡ä»¶ç»“æ„

å’Œ[classæ–‡ä»¶](https://www.jianshu.com/p/26f95965320e)ç±»ä¼¼ï¼ŒELFæ–‡ä»¶å­˜æ”¾æ•°æ®çš„æ ¼å¼ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œè®¡ç®—æœºåœ¨è§£æç›®æ ‡æ–‡ä»¶æ—¶ï¼Œå°±æ˜¯æŒ‰ç…§å®ƒæ¯ä¸ªå­—æ®µçš„æ•°æ®ç»“æ„è¿›è¡Œé€å­—è§£æçš„ã€‚ELFæ–‡ä»¶ç»“æ„ä¿¡æ¯å®šä¹‰åœ¨/usr/include/elf.hä¸­ï¼Œæ•´ä¸ªELFæ–‡ä»¶çš„ç»“æ„å¦‚ä¸‹å›¾ï¼š

![](img/ELF-file.webp)
ELFæ–‡ä»¶ç”±4éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ELFå¤´ï¼ˆELF headerï¼‰ã€ç¨‹åºå¤´è¡¨ï¼ˆProgram header tableï¼‰ã€èŠ‚ï¼ˆSectionï¼‰å’ŒèŠ‚å¤´è¡¨ï¼ˆSection header tableï¼‰ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ªæ–‡ä»¶ä¸­ä¸ä¸€å®šåŒ…å«å…¨éƒ¨å†…å®¹ï¼Œè€Œä¸”ä»–ä»¬çš„ä½ç½®ä¹Ÿæœªå¿…å¦‚åŒæ‰€ç¤ºè¿™æ ·å®‰æ’ï¼Œåªæœ‰ELFå¤´çš„ä½ç½®æ˜¯å›ºå®šçš„ï¼Œå…¶ä½™å„éƒ¨åˆ†çš„ä½ç½®ã€å¤§å°ç­‰ä¿¡æ¯ç”±ELFå¤´ä¸­çš„å„é¡¹å€¼æ¥å†³å®šã€‚

### ELF Header

ELF Headeræ˜¯ELFæ–‡ä»¶çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œ64 bitçš„ELFæ–‡ä»¶å¤´çš„ç»“æ„ä½“å¦‚ä¸‹ï¼š
```c
typedef struct
{
  unsigned char e_ident[EI_NIDENT]; /* Magic number and other info */
  Elf64_Half    e_type;         /* Object file type */
  Elf64_Half    e_machine;      /* Architecture */
  Elf64_Word    e_version;      /* Object file version */
  Elf64_Addr    e_entry;        /* Entry point virtual address */
  Elf64_Off e_phoff;        /* Program header table file offset */
  Elf64_Off e_shoff;        /* Section header table file offset */
  Elf64_Word    e_flags;        /* Processor-specific flags */
  Elf64_Half    e_ehsize;       /* ELF header size in bytes */
  Elf64_Half    e_phentsize;        /* Program header table entry size */
  Elf64_Half    e_phnum;        /* Program header table entry count */
  Elf64_Half    e_shentsize;        /* Section header table entry size */
  Elf64_Half    e_shnum;        /* Section header table entry count */
  Elf64_Half    e_shstrndx;     /* Section header string table index */
} Elf64_Ehdr;
```
æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°ç¬¬ä¸€ä¸ªåˆ†æç›®æ ‡æ–‡ä»¶çš„å·¥å…·readelfï¼Œé€šè¿‡man readelfå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥åˆ°readelfçš„ä½œç”¨å°±æ˜¯ç”¨æ¥æ˜¾ç¤ºELFæ–‡ä»¶çš„ä¿¡æ¯
```
DESCRIPTION
   readelf displays information about one or more ELF format object files. 
```
ä½¿ç”¨readelf -h simple.oæ¥è¿›è¡Œå¯¹Headerçš„è§£æï¼Œé€šè¿‡man readelfå‘½ä»¤åŒæ ·å¯ä»¥æŸ¥è¯¢åˆ°å¯¹-hå‚æ•°çš„è¯´æ˜ï¼Œ
-hç”¨æ¥æ˜¾ç¤ºELF headerçš„ç›¸å…³ä¿¡æ¯ã€‚
```
OPTIONS
   -h
   --file-header
       Displays the information contained in the ELF header at the start of the file.
```

Headerä¸­ä¸»è¦å­˜æ”¾çš„æ˜¯ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œé€šè¿‡Headerä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šåé¢å…¶ä»–å­—æ®µçš„å¤§å°å’Œèµ·å§‹åœ°å€ï¼Œé€šå¸¸æ¯”è¾ƒå…³å¿ƒçš„éƒ¨åˆ†æ˜¯ï¼šELFæ–‡ä»¶ç±»å‹ã€æ˜¯32bitè¿˜æ˜¯64bitã€Headeréƒ¨åˆ†å¤§å°ã€Sectionéƒ¨åˆ†å¤§å°å’Œæ‹¥æœ‰Sectionçš„ä¸ªæ•°ç­‰ã€‚

ç»“åˆElf64_Ehdræ¥çœ‹ï¼Œå¯¹åº”è§£æç»“æœå¦‚ä¸‹ï¼š
![](img/readelf-h.webp)

### Section
å®Œæˆäº†å¯¹Headerçš„è§£æï¼Œå†æ¥ç€åˆ†æSectionéƒ¨åˆ†ï¼ŒSectionå¯¹åº”ç»“æ„ä½“å¦‚ä¸‹ï¼š
```
typedef struct
{
  Elf64_Word  sh_name;    /* Section name (string tbl index) */
  Elf64_Word  sh_type;    /* Section type */
  Elf64_Xword sh_flags;   /* Section flags */
  Elf64_Addr  sh_addr;    /* Section virtual addr at execution */
  Elf64_Off sh_offset;    /* Section file offset */
  Elf64_Xword sh_size;    /* Section size in bytes */
  Elf64_Word  sh_link;    /* Link to another section */
  Elf64_Word  sh_info;    /* Additional section information */
  Elf64_Xword sh_addralign;   /* Section alignment */
  Elf64_Xword sh_entsize;   /* Entry size if section holds table */
} Elf64_Shdr;
```
Sectionéƒ¨åˆ†ä¸»è¦å­˜æ”¾çš„æ˜¯æœºå™¨æŒ‡ä»¤ä»£ç å’Œæ•°æ®ï¼Œæ‰§è¡Œå‘½ä»¤readelf -S -W simple.oå¯¹Sectionéƒ¨åˆ†çš„è§£æï¼Œè§£æç»“æœå’ŒElf64_Shdrä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚
```
ckt@ubuntu:~/work/elf$ readelf -S -W simple.o
There are 11 section headers, starting at offset 0x108:

Section Headers:
  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        0000000000000000 000040 000006 00  AX  0   0  4
  [ 2] .data             PROGBITS        0000000000000000 000048 000000 00  WA  0   0  4
  [ 3] .bss              NOBITS          0000000000000000 000048 000000 00  WA  0   0  4
  [ 4] .comment          PROGBITS        0000000000000000 000048 00002b 01  MS  0   0  1
  [ 5] .note.GNU-stack   PROGBITS        0000000000000000 000073 000000 00      0   0  1
  [ 6] .eh_frame         PROGBITS        0000000000000000 000078 000038 00   A  0   0  8
  [ 7] .rela.eh_frame    RELA            0000000000000000 0004b0 000018 18      9   6  8
  [ 8] .shstrtab         STRTAB          0000000000000000 0000b0 000054 00      0   0  1
  [ 9] .symtab           SYMTAB          0000000000000000 0003c8 0000d8 18     10   8  8
  [10] .strtab           STRTAB          0000000000000000 0004a0 00000e 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), l (large)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
```

å¯¹äºè¿™éƒ¨åˆ†å†…å®¹ï¼Œé€šå¸¸æˆ‘ä»¬æ¯”è¾ƒçš„Sectionæ˜¯.textï¼ˆå­˜æ”¾ä»£ç ï¼‰ã€.dataï¼ˆå­˜æ”¾å…¨å±€é™æ€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼‰å’Œ.bssï¼ˆå­˜æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼‰ ï¼Œåœ¨åé¢ä¼šå¯¹è¿™å‡ ä¸ªæ®µåˆ†åˆ«åˆ†è¿›è¡Œè§£æã€‚

æ ¹æ®readelf -S -W simple.oçš„è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºæ•´ä¸ªsimple.oçš„ç»„æˆéƒ¨åˆ†å’Œèµ·å§‹åœ°å€ï¼Œä½¿ç”¨ls -l å‘½ä»¤æŸ¥çœ‹simple.oçš„å¤§å°ï¼Œå’Œsimple.oç»“æŸåœ°å€0x0000048cæ˜¯å»åˆçš„ã€‚

```
ckt@ubuntu:~/work/elf$ ls -l simple.o
-rw-rw-r-- 1 ckt ckt 1224 Apr 12 18:42 simple.o
```
![](img/o-file.webp)

## è§£æç›®æ ‡æ–‡ä»¶
åˆ†æå®ŒELFæ–‡ä»¶ç»“æ„ï¼Œæ¥ç€æ¥è§£æä¸€ä¸ªç›®æ ‡æ–‡ä»¶ã€‚é¦–å…ˆï¼Œå‡†å¤‡å¥½æºç SimpleSection.cï¼Œæ‰§è¡Œå‘½ä»¤gcc -c SimpleSection.cç”Ÿæˆç›®æ ‡æ–‡ä»¶SimpleSection.oã€‚
```
int printf(const char* format, ...);

int global_init_var = 84;
int global_uninit_var;

void func1(int i)
{
    printf("%d\n", i);
}

int main(void)
{
    static int static_var = 85;
    static int static_var2;

    int a = 1;
    int b;
    func1(static_var + static_var2 + a + b);
    return 0;
}
```
åœ¨è¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å¦å¤–ä¸€ä¸ªå‘½ä»¤objdumpï¼Œä½¿ç”¨man objdumpæŸ¥çœ‹è¯¥å‘½ä»¤ï¼Œobjdumpæ˜¯ç”¨æ¥æ˜¾ç¤ºç›®æ ‡æ–‡ä»¶ç›¸å…³ä¿¡æ¯çš„ã€‚
```
DESCRIPTION
   objdump displays information about one or more object files. 
```

### æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„Section

æ‰§è¡Œå‘½ä»¤objdump -h SimpleSection.oå¯¹Sectionéƒ¨åˆ†è¿›è¡Œè§£æï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ¯ä¸ªæ®µçš„å¤§å°
```
[root@etcd-node02 go]# objdump -h go.exe

go.exe:     file format pei-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .text         000997d0  0000000000401000  0000000000401000  00000600  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE, DATA
  1 .rdata        000c648a  000000000049b000  000000000049b000  00099e00  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .data         00013c00  0000000000562000  0000000000562000  00160400  2**4
                  CONTENTS, ALLOC, LOAD, DATA
  3 .debug_abbrev 000001e6  0000000000597000  0000000000597000  00174000  2**2
                  CONTENTS, READONLY, DEBUGGING
  4 .debug_line   0002a088  0000000000598000  0000000000598000  00174200  2**2
                  CONTENTS, READONLY, DEBUGGING
  5 .debug_frame  00013bb4  00000000005af000  00000000005af000  0018ac00  2**2
                  CONTENTS, READONLY, DEBUGGING
  6 .debug_pubnames 00004fa6  00000000005b6000  00000000005b6000  00191000  2**2
                  CONTENTS, READONLY, DEBUGGING
  7 .debug_pubtypes 0000cca5  00000000005b8000  00000000005b8000  00192e00  2**2
                  CONTENTS, READONLY, DEBUGGING
  8 .debug_gdb_scripts 0000002c  00000000005bc000  00000000005bc000  00196200  2**0
                  CONTENTS, READONLY, DEBUGGING
  9 .debug_info   0007660a  00000000005bd000  00000000005bd000  00196400  2**2
                  CONTENTS, READONLY, DEBUGGING
 10 .debug_loc    00081376  00000000005ec000  00000000005ec000  001c4a00  2**2
                  CONTENTS, READONLY, DEBUGGING
 11 .debug_ranges 00029a00  0000000000602000  0000000000602000  001daa00  2**2
                  CONTENTS, READONLY, DEBUGGING
 12 .idata        000003b4  000000000060a000  000000000060a000  001e2800  2**2
                  CONTENTS, ALLOC, LOAD, DATA
 13 .symtab       0001fa54  000000000060b000  000000000060b000  001e2c00  2**2
                  CONTENTS, READONLY
[root@etcd-node02 go]# objdump -h go

go:     file format elf64-x86-64

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .text         000515c0  0000000000401000  0000000000401000  00001000  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .rodata       0003079e  0000000000453000  0000000000453000  00053000  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  2 .typelink     0000077c  0000000000483960  0000000000483960  00083960  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  3 .itablink     00000008  00000000004840e0  00000000004840e0  000840e0  2**3
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  4 .gosymtab     00000000  00000000004840e8  00000000004840e8  000840e8  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  5 .gopclntab    0003d7d8  0000000000484100  0000000000484100  00084100  2**5
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  6 .go.buildinfo 00000020  00000000004c2000  00000000004c2000  000c2000  2**4
                  CONTENTS, ALLOC, LOAD, DATA
  7 .noptrdata    00000be8  00000000004c2020  00000000004c2020  000c2020  2**5
                  CONTENTS, ALLOC, LOAD, DATA
  8 .data         00001e90  00000000004c2c20  00000000004c2c20  000c2c20  2**5
                  CONTENTS, ALLOC, LOAD, DATA
  9 .bss          0001b470  00000000004c4ac0  00000000004c4ac0  000c4ac0  2**5
                  ALLOC
 10 .noptrbss     00002728  00000000004dff40  00000000004dff40  000dff40  2**5
                  ALLOC
 11 .zdebug_abbrev 000001e6  00000000004e3000  00000000004e3000  000c5000  2**3
                  CONTENTS, READONLY, DEBUGGING
 12 .zdebug_line  0001896f  00000000004e3119  00000000004e3119  000c5119  2**3
                  CONTENTS, READONLY, DEBUGGING
 13 .zdebug_frame 0000ada4  00000000004f1482  00000000004f1482  000d3482  2**3
                  CONTENTS, READONLY, DEBUGGING
 14 .zdebug_pubnames 000013f3  00000000004f5040  00000000004f5040  000d7040  2**3
                  CONTENTS, READONLY, DEBUGGING
 15 .zdebug_pubtypes 00008df2  00000000004f589a  00000000004f589a  000d789a  2**3
                  CONTENTS, READONLY, DEBUGGING
 16 .debug_gdb_scripts 0000002c  00000000004f7bdc  00000000004f7bdc  000d9bdc  2**0
                  CONTENTS, READONLY, DEBUGGING
 17 .zdebug_info  00042935  00000000004f7c08  00000000004f7c08  000d9c08  2**3
                  CONTENTS, READONLY, DEBUGGING
 18 .zdebug_loc   0004de5f  00000000005131b1  00000000005131b1  000f51b1  2**3
                  CONTENTS, READONLY, DEBUGGING
 19 .zdebug_ranges 000179b0  000000000052048e  000000000052048e  0010248e  2**3
                  CONTENTS, READONLY, DEBUGGING
 20 .note.go.buildid 00000064  0000000000400f9c  0000000000400f9c  00000f9c  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA

```

æˆ‘ä»¬çš„ä»£ç æ˜¯å­˜æ”¾åˆ°.textä¸­ï¼Œå·²åˆå§‹åŒ–å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡å­˜æ”¾åœ¨.dataä¸­ï¼Œæœªåˆå§‹åŒ–å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡å­˜æ”¾åœ¨.bssä¸­
![](img/e-t-r.webp)

### ä»£ç æ®µ
æ‰§è¡Œå‘½ä»¤objdump -s -d SimpleSection.oå¯¹ä»£ç æ®µ(.text)çš„è§£æç»“æœå¦‚ä¸‹ï¼š
![](img/code-dump.webp)

### æ•°æ®æ®µå’Œåªè¯»æ•°æ®æ®µ
æ‰§è¡Œå‘½ä»¤objdump -s -d SimpleSection.oå¯¹æ•°æ®æ®µå’Œåªè¯»æ•°æ®æ®µè§£æç»“æœå¦‚ä¸‹ï¼š
![](img/data-rodata.webp)

## BSSæ®µ
æ‰§è¡Œå‘½ä»¤objdump -x -s -d SimpleSection.oæ‰“å°å‡ºç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œé€šè¿‡ç¬¦å·è¡¨æˆ‘ä»¬å¯ä»¥çŸ¥é“å„ä¸ªå˜é‡çš„å­˜æ”¾ä½ç½®ï¼Œåªæœ‰æœªåˆå§‹åŒ–çš„å±€éƒ¨é™æ€å˜é‡static_var2è¢«æ”¾åˆ°äº†.bssæ®µï¼Œè€Œglobal_uninit_varè¢«æ”¾å…¥äº†commentæ®µ

![](img/bss.webp)

å¦å¤–ï¼Œè¢«åˆå§‹åŒ–ä¸º0çš„é™æ€å˜é‡ä¹Ÿä¼šè¢«æ”¾å…¥.bssæ®µï¼Œå› ä¸ºæœªåˆå§‹å˜é‡çš„å€¼ä¹Ÿæ˜¯0ï¼Œç»è¿‡ä¼˜åŒ–åè¢«æ”¾å…¥.bssæ®µï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç£ç›˜ç©ºé—´ï¼Œå› ä¸º.bssä¸å ç£ç›˜ç©ºé—´

ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ä¸­x1ä¼šè¢«æ”¾å…¥.bssæ®µï¼Œè€Œx2è¢«æ”¾å…¥.dataæ®µ

```
static int x1 = 0;
static int x2 = 12;
```
![](img/bss-0.webp)
[TOC]
# High Performance Go Workshopï¼ˆPart5ï¼‰

## 5\. æ‰§è¡Œè¿½è¸ªå™¨

  

æ‰§è¡Œè¿½è¸ªç¨‹åºæ˜¯ç”± [Dmitry Vyukov](https://github.com/dvyukov) ä¸º GO 1.5 å¼€å‘çš„ã€‚

  

ä¸åŸºäºç¤ºä¾‹çš„åˆ†æä¸åŒï¼Œæ‰§è¡Œè·Ÿè¸ªç¨‹åºé›†æˆåˆ° Go runtime ä¸­ï¼Œå› æ­¤å®ƒåªçŸ¥é“ go ç¨‹åºåœ¨ç‰¹å®šæ—¶é—´ç‚¹åœ¨åšä»€ä¹ˆã€‚

  

### 5.1. ä»€ä¹ˆæ˜¯æ‰§è¡Œè·Ÿè¸ªå™¨ï¼Œä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

  

æˆ‘è®¤ä¸ºæœ€ç®€å•çš„è§£é‡Šæ˜¯æ‰§è¡Œè·Ÿè¸ªå™¨åšäº†ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒæ˜¯é‡è¦çš„ï¼Œé€šè¿‡æŸ¥çœ‹ä¸€æ®µä»£ç ä¸­ pprof, go tool pprof æ€§èƒ½è¾ƒå·®ã€‚

  

`examples/mandelbrot`ç›®å½•åŒ…å«ä¸€ä¸ªç®€å•çš„ mandelbrotÂ ç”Ÿæˆå™¨ã€‚æ­¤ä»£ç æºè‡ª [Francesc Campoyâ€™s mandelbrot package](https://github.com/campoy/mandelbrot).

  
```
cd examples/mandelbrot 
go build && ./mandelbrot
```
  

  

å¦‚æœæˆ‘ä»¬ buildï¼Œç„¶å run ï¼Œå®ƒä¼šäº§ç”Ÿè¿™æ ·çš„ä¸œè¥¿

  

  
 ![](../../img/go/go-003.png) 

  

#### 5.1.1. éœ€è¦å¤šé•¿æ—¶é—´?

  

é‚£ä¹ˆï¼Œè¿™ä¸ªç¨‹åºç”Ÿæˆ 1024x 1024 åƒç´ çš„å›¾åƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

  

æˆ‘çŸ¥é“çš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ `time(1)`ã€‚

  
```
% time ./mandelbrot 
real    0m1.654s 
user    0m1.630s 
sys     0m0.015s
```
  

> ä¸è¦ä½¿ç”¨ `time go run mandebrot.go`ï¼Œå¦åˆ™å°†è®¡ç®—ç¼–è¯‘å’Œè¿è¡Œç¨‹åºæ‰€éœ€çš„æ—¶é—´ã€‚

  

#### 5.1.2. ç¨‹åºæ­£åœ¨åšä»€ä¹ˆï¼Ÿ

  

å› æ­¤ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œç¨‹åºç”¨äº† 1.6 ç§’ç”Ÿæˆ mandelbrot å¹¶å†™å…¥å›¾ç‰‡ã€‚

  

è¿™æ ·å¯ä»¥äº†å—ï¼Ÿæˆ‘ä»¬èƒ½å¿«ç‚¹å—ï¼Ÿ

  

è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ Go å†…ç½®çš„ pprof æ”¯æŒæ¥åˆ†æç¨‹åºã€‚

  

### 5.2. ç”Ÿæˆåˆ†ææ–‡ä»¶

  

è¦è½¬ä¸ºç”Ÿæˆåˆ†ææ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦

  

1.  ç›´æ¥ä½¿ç”¨ `runtime/pprof` package  
    

  

2.  ä½¿ç”¨åƒ `github.com/pkg/profile` è¿™æ ·çš„è£…é¥°å™¨æ¥å®ç°è‡ªåŠ¨åŒ–ã€‚

  

  

### 5.3.ä½¿ç”¨ runtime/pprof ç”Ÿæˆåˆ†ææ–‡ä»¶

  

è®©æˆ‘ä»¬ä¿®æ”¹ç¨‹åºå†™ä¸€ä¸ªCPUåˆ†ææ–‡ä»¶ `os.Stdout`ã€‚

  
```
import "runtime/pprof"   
func main() {  
    pprof.StartCPUProfile(os.Stdout) 
    defer pprof.StopCPUProfile()
```
  

é€šè¿‡å°†æ­¤ä»£ç æ·»åŠ åˆ°Â `main`  å‡½æ•°çš„é¡¶éƒ¨ï¼Œè¿™ä¸ªç¨‹åºä¼šå‘Â `os.Stdout` å†™å…¥åˆ†ææ–‡ä»¶ã€‚

  
```
cd examples/mandelbrot-runtime-pprof 
go run mandelbrot.go > cpu.pprof
```
  

> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `go run`ï¼Œå› ä¸º cpu åˆ†æåªåŒ…æ‹¬ `mandelbrot.go` çš„æ‰§è¡Œï¼Œè€Œä¸åŒ…æ‹¬å®ƒçš„ç¼–è¯‘ã€‚

  

#### 5.3.1. åˆ©ç”¨ github.com/pkg/profile ç”Ÿæˆåˆ†ææ–‡ä»¶

  

å‰ä¸€å¼ å¹»ç¯ç‰‡å±•ç¤ºäº†ä¸€ç§ç”Ÿæˆåˆ†ææ–‡ä»¶çš„çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€äº›é—®é¢˜ã€‚

  

*   å¦‚æœå¿˜è®°å°†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ï¼Œåˆ™ä¼šç»ˆæ­¢è¯¥ç»ˆç«¯ä¼šè¯ã€‚ï¼ˆæç¤ºï¼š`reset(1)` å°†å¸®åŠ©ä½ ï¼‰

  

*   å¦‚æœä½ åœ¨ `os.Stdout` ä¸Šå†™å…¶ä»–ä¸œè¥¿ï¼Œä¾‹å¦‚ `fmt.Println`ï¼Œä½ ä¼šç ´åè·Ÿè¸ªã€‚

  

å»ºè®®ä½¿ç”¨ `runtime/pprof` çš„æ–¹æ³•æ˜¯å°†è·Ÿè¸ªå†™å…¥æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¿…é¡»ç¡®ä¿è·Ÿè¸ªå·²åœæ­¢ï¼Œå¹¶ä¸”åœ¨ç¨‹åºåœæ­¢ä¹‹å‰å…³é—­äº†æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬å¦‚æœæœ‰äºº\`^ C ã€‚

  

æ‰€ä»¥ï¼Œå‡ å¹´å‰æˆ‘å†™äº†ä¸€ä¸ª [package](https://godoc.org/github.gom/pkg/profile) æ¥å¤„ç†å®ƒã€‚

  
```
import "github.com/pkg/profile"   
func main() {  
    defer profile.Start(profile.CPUProfile, 
    profile.ProfilePath(".")).Stop()
```
  

å¦‚æœæˆ‘ä»¬è¿è¡Œè¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°å†™å…¥åˆ°å½“å‰å·¥ä½œç›®å½•ä¸­çš„åˆ†ææ–‡ä»¶

  
```
% go run mandelbrot.go 
2017/09/17 12:22:06 profile: cpu profiling enabled, cpu.pprof 
2017/09/17 12:22:08 profile: cpu profiling disabled, cpu.pprof
```
  

> æ˜¯å¦ä½¿ç”¨ `pkg/profile` å¹¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†æ˜¯å®ƒä¼šå¤„ç†æ”¶é›†å’Œè®°å½•è·Ÿè¸ªçš„è®¸å¤šæ ·æ¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨æœ¬æ¬¡ç ”è®¨ä¼šä¸­ä½¿ç”¨å®ƒã€‚

  

  

#### 5.3.2. åˆ†ææ–‡ä»¶

  

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ†ææ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `go tool pprof` æ¥åˆ†æå®ƒã€‚

  
```
% go tool pprof -http=:8080 cpu.pprof
```
  

åœ¨è¿™æ¬¡è¿è¡Œä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¨‹åºè¿è¡Œäº† 1.81 ç§’ï¼ˆåˆ†æä¼šå¢åŠ ä¸€ç‚¹å¼€é”€ï¼‰ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ° pprof åªæ•è·äº† 1.53 ç§’çš„æ•°æ®ï¼Œå› ä¸º pprof æ˜¯åŸºäºç¤ºä¾‹çš„ï¼Œä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ `SIGPROF` è®¡æ—¶å™¨ã€‚

  

> ç”±äº Go 1.9 `pprof` è·Ÿè¸ªåŒ…å«åˆ†æè·Ÿè¸ªæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚ä½ ä¸å†éœ€è¦æœ‰äº§ç”Ÿè·Ÿè¸ªçš„åŒ¹é…äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ğŸ‰

  

æˆ‘ä»¬å¯ä»¥ç”¨ `top` pprof å‡½æ•°å¯¹è·Ÿè¸ªè®°å½•çš„å‡½æ•°è¿›è¡Œæ’åºã€‚

  
```
% go tool pprof cpu.pprof 
Type: cpu 
Time: Mar 24, 2019 at 5:18pm (CET) 
Duration: 2.16s, Total samples = 1.91s (88.51%) 
Entering interactive mode (type "help" for commands, "o" for options) 
(pprof) top 
Showing nodes accounting for 1.90s, 99.48% of 1.91s total 
Showing top 10 nodes out of 35  
flat  flat%   sum%        cum   cum% 
0.82s 42.93% 42.93%      1.63s 85.34%  main.fillPixel 
0.81s 42.41% 85.34%      0.81s 42.41%  main.paint 
0.11s  5.76% 91.10%      0.12s  6.28%  runtime.mallocgc 
0.04s  2.09% 93.19%      0.04s  2.09%  runtime.memmove 
0.04s  2.09% 95.29%      0.04s  2.09%  runtime.nanotime 
0.03s  1.57% 96.86%      0.03s  1.57%  runtime.pthread\_cond\_signal 
0.02s  1.05% 97.91%      0.04s  2.09%  compress/flate.(\*compressor).deflate 
0.01s  0.52% 98.43%      0.01s  0.52%  compress/flate.(\*compressor).findMatch 
0.01s  0.52% 98.95%      0.01s  0.52%  compress/flate.hash4 
0.01s  0.52% 99.48%      0.01s  0.52%  image/png.filter
```
  

  

æˆ‘ä»¬çœ‹åˆ°ï¼Œå½“ pprof æ•è·å †æ ˆæ—¶ï¼Œ`main.fillPixel` å‡½æ•°åœ¨ CPU ä¸Šè¿è¡Œå¾—æœ€å¤šã€‚

  

åœ¨å †æ ˆä¸Šæ‰¾åˆ° `main.paint` å¹¶ä¸å¥‡æ€ªï¼Œè¿™æ˜¯ç¨‹åºæ‰€åšçš„ï¼›å®ƒè´Ÿè´£ç»˜åˆ¶åƒç´ ã€‚ä½†æ˜¯æ˜¯ä»€ä¹ˆå¯¼è‡´ `paint` èŠ±äº†è¿™ä¹ˆå¤šæ—¶é—´ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨*cummulative*Â  å‘½ä»¤Â `top` æ¥æ£€æŸ¥ã€‚

  
```
(pprof) top --cum 
Showing nodes accounting for 1630ms, 85.34% of 1910ms total 
Showing top 10 nodes out of 35  
flat  flat%   sum%        cum   cum% 
0     0%     0%     1840ms 96.34%  main.main 
0     0%     0%     1840ms 96.34%  runtime.main 
820ms 42.93% 42.93%     1630ms 85.34%  main.fillPixel 
0     0% 42.93%     1630ms 85.34%  main.seqFillImg 
810ms 42.41% 85.34%      810ms 42.41%  main.paint 
0     0% 85.34%      210ms 10.99%  image/png.(\*Encoder).Encode 
0     0% 85.34%      210ms 10.99%  image/png.Encode 
0     0% 85.34%      160ms  8.38%  main.(\*img).At 
0     0% 85.34%      160ms  8.38%  runtime.convT2Inoptr 
0     0% 85.34%      150ms  7.85%  image/png.(\*encoder).writeIDATs
```
  

è¿™è¡¨æ˜ `main.fillPixed` å®é™…ä¸Šåœ¨åšå¤§éƒ¨åˆ†å·¥ä½œã€‚

  

> ä½ è¿˜å¯ä»¥ä½¿ç”¨ `web` å‘½ä»¤å¯è§†åŒ–é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
> 
>   
> 
>  ![å›¾ç‰‡.png](../../img/go/pprof-5.png) 

  

  

### 5.4. è·Ÿè¸ª VS åˆ†æ

  

å¸Œæœ›è¿™ä¸ªä¾‹å­å±•ç¤ºäº†åˆ†æçš„å±€é™æ€§ã€‚åˆ†æå‘Šè¯‰æˆ‘ä»¬åˆ†æå™¨çœ‹åˆ°äº†ä»€ä¹ˆï¼›`fillPixel` æ­£åœ¨åšæ‰€æœ‰çš„å·¥ä½œã€‚ä¼¼ä¹æ²¡æœ‰å¾ˆå¤šäº‹æƒ…å¯ä»¥åšçš„äº†ã€‚

  

æ‰€ä»¥ç°åœ¨æ˜¯å¼•å…¥æ‰§è¡Œè·Ÿè¸ªç¨‹åºçš„å¥½æ—¶æœºï¼Œå®ƒå¯ä»¥ä¸ºåŒä¸€ä¸ªç¨‹åºæä¾›ä¸åŒçš„è§†å›¾ã€‚

  

#### 5.4.1. ä½¿ç”¨æ‰§è¡Œè·Ÿè¸ª

  

ä½¿ç”¨è·Ÿè¸ªç¨‹åºå°±åƒè¯·æ±‚ `profile.TraceProfile` ä¸€æ ·ç®€å•ï¼Œæ²¡æœ‰å…¶ä»–çš„å˜åŒ–ã€‚

  

  
```
import "github.com/pkg/profile"   
func main() {  
    defer profile.Start(profile.TraceProfile, profile.ProfilePath(".")).Stop()
```
  

  

å½“æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶ï¼Œä¼šåœ¨å½“å‰å·¥ä½œç›®å½•ä¸­å¾—åˆ°ä¸€ä¸ª`trace.out` æ–‡ä»¶ã€‚

  
```
% go build mandelbrot.go 
% % time ./mandelbrot 
2017/09/17 13:19:10 profile: trace enabled, trace.out 
2017/09/17 13:19:12 profile: trace disabled, trace.out 
real    0m1.740s 
user    0m1.707s 
sys     0m0.020s
```
  

  

ä¸ pprof ä¸€æ ·ï¼Œ`go` å‘½ä»¤ä¸­ä¹Ÿæœ‰ä¸€ä¸ªå·¥å…·æ¥åˆ†æè·Ÿè¸ªã€‚

  
```
% go tool trace trace.out 
2017/09/17 12:41:39 Parsing trace... 
2017/09/17 12:41:40 Serializing trace... 
2017/09/17 12:41:40 Splitting trace... 
2017/09/17 12:41:40 Opening browser. Trace viewer s listening on http://127.0.0.1:57842
```
  

  

è¿™ä¸ªå·¥å…·å’Œ `go tool pprof`  æœ‰ç‚¹ä¸åŒã€‚æ‰§è¡Œè·Ÿè¸ªç¨‹åºæ­£åœ¨é‡ç”¨ Chrome ä¸­å†…ç½®çš„è®¸å¤šåˆ†ææ–‡ä»¶å¯è§†åŒ–åŸºç¡€è®¾æ–½ï¼Œå› æ­¤ `go tool trace` å……å½“æœåŠ¡å™¨ï¼Œå°†åŸå§‹æ‰§è¡Œè·Ÿè¸ªè½¬æ¢ä¸º Chrome å¯ä»¥æœ¬æœºæ˜¾ç¤ºçš„æ•°æ®ã€‚

  

#### 5.4.2. åˆ†æè·Ÿè¸ª

  

ä»è·Ÿè¸ªä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç¨‹åºåªä½¿ç”¨äº†ä¸€ä¸ª CPUã€‚

  
```
func seqFillImg(m *img) {  
    for i, row := range m.m { 
        for j := range row { 
            fillPixel(m, i, j) 
        } 
    } 
}
```
  

è¿™å¹¶ä¸å¥‡æ€ªï¼Œé»˜è®¤æƒ…å†µä¸‹ `mandelbrot.go` ä¼šæŒ‰é¡ºåºä¸ºæ¯ä¸€è¡Œä¸­çš„æ¯ä¸€ä¸ªåƒç´ è°ƒç”¨ `fillPixel` ã€‚

  

ç»˜åˆ¶å›¾åƒåï¼Œè¯·å‚é˜…æ‰§è¡Œå¼€å…³ä»¥å†™å…¥ `.png` æ–‡ä»¶ã€‚è¿™ä¼šåœ¨å †ä¸Šç”Ÿæˆåƒåœ¾ï¼Œå› æ­¤è·Ÿè¸ªåœ¨è¿™ä¸€ç‚¹ä¸Šå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åƒåœ¾æ”¶é›†å †çš„å…¸å‹é”¯é½¿æ¨¡å¼ã€‚

  

è·Ÿè¸ªåˆ†ææ–‡ä»¶æä¾›äº†å¾®ç§’çº§çš„æ—¶é—´åˆ†è¾¨ç‡ã€‚è¿™æ˜¯å¤–éƒ¨åˆ†ææ‰€ä¸èƒ½å¾—åˆ°çš„ã€‚

  

> go tool trace
> 
>   
> 
> åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åº”è¯¥è°ˆè°ˆè·Ÿè¸ªå·¥å…·çš„ä½¿ç”¨ã€‚
> 
>   
> 
> *   è¯¥å·¥å…·ä½¿ç”¨å†…ç½®åœ¨ Chrome ä¸­çš„ JavaScript è°ƒè¯•æ”¯æŒã€‚è·Ÿè¸ªé…ç½®æ–‡ä»¶åªèƒ½åœ¨ Chrome ä¸­æŸ¥çœ‹ï¼Œåœ¨ Firefoxã€Safariã€IE/Edge ä¸­ä¸èµ·ä½œç”¨ã€‚
> 
>   
> 
> *   å› ä¸ºè¿™æ˜¯ä¸€ä¸ª Google äº§å“ï¼Œå®ƒæ”¯æŒé”®ç›˜å¿«æ·é”®ï¼›ä½¿ç”¨ `WASD` å¯¼èˆªï¼Œä½¿ç”¨ `?` å¾—åˆ°ä¸€ä»½æ¸…å•ã€‚
> 
>   
> 
> *   æŸ¥çœ‹è·Ÿè¸ªä¼šå ç”¨å¤§é‡å†…å­˜ã€‚è¯´çœŸçš„ï¼Œ4GBä¸å¤Ÿç”¨ï¼Œ8GBä¼°è®¡å‹‰å¼ºï¼Œä¸Šæ›´é«˜çš„å†…å­˜è‚¯å®šæ›´å¥½ã€‚
> 
>   
> 
> *    å¦‚æœä½ æ˜¯ä»Fedoraä¹‹ç±»çš„OSå‘è¡Œç‰ˆä¸­å®‰è£…Goçš„ï¼Œé‚£ä¹ˆè·Ÿè¸ªæŸ¥çœ‹å™¨çš„æ”¯æŒæ–‡ä»¶å¯èƒ½ä¸æ˜¯ `golang` deb/rpmÂ main ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬å¯èƒ½åœ¨ä¸€äº› `-extra` çš„åŒ…ä¸­ã€‚

  

  

### 5.5. ä½¿ç”¨å¤šä¸ªCPU

  

æˆ‘ä»¬ä»å‰é¢çš„è·Ÿè¸ªä¸­çœ‹åˆ°ï¼Œç¨‹åºæŒ‰é¡ºåºè¿è¡Œï¼Œæ²¡æœ‰åˆ©ç”¨è¿™å°æœºå™¨ä¸Šçš„å…¶ä»–çš„ CPUã€‚

  

Mandelbrot generation è¢«ç§°ä¸º *embarassingly\_parallel*ï¼ˆä»¤äººå°´å°¬çš„å¹¶è¡Œï¼‰ã€‚æ¯ä¸ªåƒç´ éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å¹¶è¡Œè®¡ç®—ã€‚æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬è¯•è¯•ã€‚

  
```
% go build mandelbrot.go 
% time ./mandelbrot -mode px 
2017/09/17 13:19:48 profile: trace enabled, trace.out 
2017/09/17 13:19:50 profile: trace disabled, trace.out 
real    0m1.764s 
user    0m4.031s 
sys     0m0.865s
```
  

  

å› æ­¤ï¼Œè¿è¡Œæ—¶é—´åŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ã€‚  æˆ‘ä»¬ä½¿ç”¨äº†æ‰€æœ‰çš„ CPUï¼Œå› æ­¤æœ‰æ›´å¤šçš„ç”¨æˆ·æ—¶é—´ï¼Œè¿™æ˜¯æœ‰é“ç†çš„ï¼Œä½†æ˜¯å®é™…ï¼ˆwall clockï¼‰æ—¶é—´å¤§è‡´ç›¸åŒã€‚

  

è®©æˆ‘ä»¬çœ‹çœ‹è·Ÿè¸ªã€‚

  

æ­£å¦‚æ‰€çœ‹åˆ°çš„ï¼Œè¿™ä¸ªè·Ÿè¸ªç”Ÿæˆäº†æ›´å¤šçš„æ•°æ®ã€‚

  

*   çœ‹èµ·æ¥æœ‰å¾ˆå¤šå·¥ä½œè¦åšï¼Œä½†å¦‚æœä½ æ”¾å¤§ï¼Œå°±ä¼šå‘ç°æœ‰å·®è·ã€‚è¿™å°±æ˜¯è°ƒåº¦ç¨‹åºã€‚

  

*   å½“æˆ‘ä»¬ä½¿ç”¨æ‰€æœ‰å››ä¸ªæ ¸å¿ƒæ—¶ï¼Œå› ä¸ºæ¯ä¸ª `fillPixel` çš„å·¥ä½œé‡ç›¸å¯¹è¾ƒå°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒåº¦å¼€é”€ä¸ŠèŠ±è´¹äº†å¤§é‡æ—¶é—´ã€‚

  

### 5.6. åˆ†æ‰¹å·¥ä½œ

  

æ¯åƒç´ ä½¿ç”¨ä¸€ä¸ª goroutine å¤ªç»†ç²’åº¦äº†ã€‚æ²¡æœ‰è¶³å¤Ÿçš„å·¥ä½œæ¥è¯æ˜ goroutine çš„å¼€é”€æ˜¯åˆç†çš„ã€‚

  

è®©æˆ‘ä»¬å°è¯•æ¯ä¸ª goroutine å¤„ç†ä¸€è¡Œã€‚
```
% go build mandelbrot.go 
% time ./mandelbrot -mode row 
2017/09/17 13:41:55 profile: trace enabled, trace.out 
2017/09/17 13:41:55 profile: trace disabled, trace.out 
real    0m0.764s 
user    0m1.907s 
sys     0m0.025s
```
  

è¿™çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ”¹è¿›ï¼Œæˆ‘ä»¬å‡ ä¹æŠŠç¨‹åºçš„è¿è¡Œæ—¶é—´å‡å°‘äº†ä¸€åŠã€‚è®©æˆ‘ä»¬çœ‹çœ‹è·Ÿè¸ªã€‚

  

æ­£å¦‚æ‰€çœ‹åˆ°çš„ï¼Œè·Ÿè¸ªç°åœ¨æ›´å°ï¼Œæ›´å®¹æ˜“ä½¿ç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ span ä¸­çœ‹åˆ°æ•´ä¸ªç—•è¿¹ã€‚

  

*   åœ¨ç¨‹åºå¼€å§‹æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ° goroutines çš„æ•°é‡å¢åŠ åˆ°1000ä¸ªå·¦å³ã€‚è¿™æ¯”æˆ‘ä»¬åœ¨ä¸Šä¸€æ¬¡è·Ÿè¸ªä¸­çœ‹åˆ°çš„ 1 << 20 æœ‰æ‰€æ”¹è¿›ã€‚

  

*   æ”¾å¤§åï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ª `onePerRowFillImg` è¿è¡Œæ›´é•¿æ—¶é—´ï¼Œå¹¶ä¸”éšç€ goroutine ç”Ÿæˆå·¥ä½œæå‰å®Œæˆï¼Œè°ƒåº¦å™¨å°†æœ‰æ•ˆåœ°å¤„ç†å‰©ä½™çš„å¯è¿è¡Œ goroutineã€‚

  

  

### 5.7. ä½¿ç”¨ workers

  

`mandelbrot.go` æ”¯æŒå¦å¤–ä¸€ä¸ªæ¨¡å¼ã€‚

  
```
% go build mandelbrot.go 
% time ./mandelbrot -mode workers 
2017/09/17 13:49:46 profile: trace enabled, trace.out 
2017/09/17 13:49:50 profile: trace disabled, trace.out   
real    0m4.207s 
user    0m4.459s 
sys     0m1.284s
```
  

  

æ‰€ä»¥ï¼Œruntime æ¯”ä»¥å‰å·®å¥½å¤šã€‚è®©æˆ‘ä»¬çœ‹çœ‹è·Ÿè¸ªï¼Œçœ‹çœ‹èƒ½ä¸èƒ½çœ‹å‡ºå‘ç”Ÿäº†ä»€ä¹ˆäº‹ã€‚

  

æŸ¥çœ‹è·Ÿè¸ªå¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ä¸€ä¸ªÂ worker è¿›ç¨‹ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¾€å¾€ä¼šè½®æ¢ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªç”Ÿäº§è€…å’Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è®©æˆ‘ä»¬å¢åŠ  worker çš„æ•°é‡

  
```
% go build mandelbrot.go 
% time ./mandelbrot -mode workers -workers 4 
2017/09/17 13:52:51 profile: trace enabled, trace.out 
2017/09/17 13:52:57 profile: trace disabled, trace.out   
real    0m5.528s 
user    0m7.307s 
sys     0m4.311s
```
  

  

é‚£å°±æ›´ç³Ÿäº†ï¼æ¶ˆè€—æ›´å¤šçš„è¿è¡Œæ—¶é—´ï¼Œæ›´å¤šçš„CPUæ—¶é—´ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è·Ÿè¸ªå‘ç”Ÿäº†ä»€ä¹ˆã€‚

  

è·Ÿè¸ªæ²¡æ³•çœ‹ã€‚å› ä¸ºæœ‰æ›´å¤šçš„ worker å¯ä¾›é€‰æ‹©ï¼Œä½†ä»–ä»¬ä¼¼ä¹æŠŠæ‰€æœ‰çš„æ—¶é—´éƒ½èŠ±åœ¨äº‰å¤ºÂ workÂ  ä¸Š ã€‚

  

è¿™æ˜¯å› ä¸ºé€šé“æ˜¯æ— ç¼“å†²çš„ã€‚åœ¨å‡†å¤‡å¥½æ¥æ”¶ä¹‹å‰ï¼Œæ— ç¼“å†²ä¿¡é“æ— æ³•å‘é€æ¶ˆæ¯ã€‚

  

*   åœ¨ä¸€ä¸ªæ¶ˆè´¹è€…å‡†å¤‡å¥½æ¥æ”¶å†…å®¹ä¹‹å‰ï¼Œç”Ÿäº§è€…ä¸èƒ½å‘é€æ¶ˆæ¯ã€‚

  

*   æ¶ˆè´¹è€…ä»¬åªæœ‰ç­‰åˆ°æœ‰äººå‡†å¤‡å¥½äº†æ‰å¯ä»¥æ¥å—æ¶ˆæ¯ï¼Œæ‰€ä»¥ä»–ä»¬åœ¨ç­‰å¾…çš„æ—¶å€™äº’ç›¸ç«äº‰ã€‚

  

*   å‘é€æ–¹æ²¡æœ‰ç‰¹æƒï¼Œå®ƒä¸èƒ½æ¯”å·²ç»è¿è¡Œçš„æ¶ˆè´¹è€…äº«æœ‰ä¼˜å…ˆæƒã€‚

  

  

æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„æ˜¯æœªç¼“å†²é€šé“å¼•å…¥çš„å»¶è¿Ÿã€‚è°ƒåº¦ç¨‹åºå†…æœ‰å¾ˆå¤šåœæ­¢å’Œå¯åŠ¨ï¼Œåœ¨ç­‰å¾…å·¥ä½œæ—¶å¯èƒ½ä¼šé”å®šå’Œäº’æ–¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çœ‹åˆ° `sys` æ¶ˆè€—çš„æ—¶é—´æ›´å¤šçš„åŸå› ã€‚

  

  

### 5.8. ä½¿ç”¨ç¼“å†²é€šé“

  
```
import "github.com/pkg/profile"   
func main() {  
    defer profile.Start(profile.TraceProfile, profile.ProfilePath(".")).Stop()
```
  

  
```
% go build mandelbrot.go 
% time ./mandelbrot -mode workers -workers 4 
2017/09/17 14:23:56 profile: trace enabled, trace.out 
2017/09/17 14:23:57 profile: trace disabled, trace.out   
real    0m0.905s 
user    0m2.150s 
sys     0m0.121s
```
  

  

éå¸¸æ¥è¿‘ä¸Šé¢æ¯ä¸€è¡Œçš„æ¨¡å¼ã€‚

  

ä½¿ç”¨ç¼“å†²é€šé“è·Ÿè¸ªæ˜¾ç¤ºï¼š

  

*   ç”Ÿäº§è€…ä¸å¿…ç­‰æ¶ˆè´¹è€…æ¥ï¼Œå®ƒå¯ä»¥å¾ˆå¿«å¡«æ»¡ä¿¡é“ã€‚

  

*   æ¶ˆè´¹è€…å¯ä»¥å¿«é€Ÿåœ°ä»ä¿¡é“è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œè€Œæ— éœ€åœ¨æ¶ˆæ¯ç”Ÿäº§æ—¶ç¡çœ ã€‚

  

ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¿¡é“æ¥åˆ†é…æ¯ä¸€ä¸ªåƒç´ çš„å·¥ä½œï¼Œå…¶é€Ÿåº¦å‡ ä¹ä¸ä¹‹å‰åœ¨æ¯è¡Œ goroutine ä¸Šè°ƒåº¦çš„é€Ÿåº¦ç›¸åŒã€‚

  

> å°† `nWorkersFillImg` ä¿®æ”¹ä¸ºæ¯è¡Œå·¥ä½œã€‚å¯¹ç»“æœè¿›è¡Œæ—¶é—´åˆ†æå¹¶åˆ†æè·Ÿè¸ªã€‚

  

### 5.9. Mandelbrot å¾®æœåŠ¡

  

åœ¨2019å¹´ï¼Œé™¤éä½ å¯ä»¥å°† Internet ä½œä¸ºæ— æœåŠ¡å™¨å¾®æœåŠ¡æä¾›ï¼Œå¦åˆ™ç”Ÿæˆ Mandelbrots æ¯«æ— æ„ä¹‰ã€‚  å› æ­¤ï¼Œæˆ‘å‘ä½ ä»‹ç» *Mandelweb*

  
```
% go run examples/mandelweb/mandelweb.go 
2017/09/17 15:29:21 listening on http://127.0.0.1:8080/
```
  

[http://127.0.0.1:8080/mandelbrot](http://127.0.0.1:8080/mandelbrot)

  

#### 5.9.1. è·Ÿè¸ªè¿è¡Œçš„åº”ç”¨ç¨‹åº

  

åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯¹æ•´ä¸ªç¨‹åºè¿è¡Œäº†è·Ÿè¸ªã€‚

  

å¦‚ä½ æ‰€è§ï¼Œè·Ÿè¸ªå¯èƒ½éå¸¸å¤§ï¼Œå³ä½¿æ˜¯åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…ï¼Œå› æ­¤è¿ç»­æ”¶é›†è·Ÿè¸ªæ•°æ®ä¼šäº§ç”Ÿå¤ªå¤šçš„æ•°æ®ã€‚æ­¤å¤–ï¼Œè·Ÿè¸ªè¿˜ä¼šå¯¹ç¨‹åºçš„é€Ÿåº¦äº§ç”Ÿå½±å“ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰å¤§é‡æ´»åŠ¨çš„æƒ…å†µä¸‹ã€‚

  

æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ç§ä»æ­£åœ¨è¿è¡Œçš„ç¨‹åºä¸­æ”¶é›†çŸ­è·Ÿè¸ªçš„æ–¹æ³•ã€‚

  

å¥½åœ¨`net/http/pprof` åŒ…å°±æ˜¯è¿™æ ·ä¸€ä¸ªå·¥å…·ã€‚

  

#### 5.9.2. é€šè¿‡httpæ”¶é›†è·Ÿè¸ª

  

å¸Œæœ›å¤§å®¶éƒ½çŸ¥é“ `net/http/pprof` åŒ…ã€‚

  

import \_ "net/http/pprof"

  

å¯¼å…¥æ—¶ï¼Œ`net/http/pprof` å°†ä½¿ç”¨ `http.DefaultServeMux` æ³¨å†Œè·Ÿè¸ªå’Œåˆ†æè·¯ç”±ã€‚ä» Go 1.5 å¼€å§‹ï¼Œè¿™åŒ…æ‹¬è·Ÿè¸ªæ¢æŸ¥å™¨ã€‚

  

> `net/http/pprof` å‘ `http.DefaultServeMux` æ³¨å†Œã€‚å¦‚æœä½ æ­£åœ¨éšå¼æˆ–æ˜¾å¼åœ°ä½¿ç”¨è¯¥ `ServeMux` ï¼Œåˆ™å¯èƒ½ä¼šæ— æ„ä¸­å°† pprof ç«¯ç‚¹å…¬å¼€åˆ°ç½‘ç»œä¸Šã€‚è¿™å¯èƒ½å¯¼è‡´æºä»£ç æ³„éœ²ã€‚ä½ å¯èƒ½ä¸æƒ³è¿™ä¹ˆåšã€‚

  

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `curl`  (æˆ– `wget`) ä» mandelweb è·å–äº”ç§’é’Ÿçš„è·Ÿè¸ª

  
```
% curl -o trace.out http://127.0.0.1:8080/debug/pprof/trace?seconds=5
```
  

  

#### 5.9.3. äº§ç”Ÿä¸€äº›è´Ÿè½½

  

ä¸Šä¸€ä¸ªä¾‹å­å¾ˆæœ‰è¶£ï¼Œä½†æ˜¯æ ¹æ®å®šä¹‰ï¼Œç©ºé—²çš„ web æœåŠ¡å™¨æ²¡æœ‰æ€§èƒ½é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦äº§ç”Ÿä¸€äº›è´Ÿè·ã€‚å› æ­¤æˆ‘ç”¨çš„æ˜¯ [JBD](https://github.com/rakyll/hey) çš„ `hey`ã€‚ï¼ˆGoogleå¤§ä½¬ã€‚ã€‚ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¹ˆæ¼‚äº®çš„mmï¼‰

  
```
% go get -u github.com/rakyll/hey
```
  

è®©æˆ‘ä»¬ä»æ¯ç§’ä¸€ä¸ªè¯·æ±‚å¼€å§‹ã€‚

  
```
% hey -c 1 -n 1000 -q 1 http://127.0.0.1:8080/mandelbrot
```
  

è¿è¡Œä¹‹åï¼Œåœ¨å¦ä¸€ä¸ªçª—å£ä¸­æ”¶é›†è·Ÿè¸ª

  
```
% curl -o trace.out http://127.0.0.1:8080/debug/pprof/trace?seconds=5  
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current Dload  Upload   Total   Spent    Left  Speed 
100 66169    0 66169    0     0  13233      0 --:--:--  0:00:05 --:--:-- 17390 

% go tool trace trace.out 
2017/09/17 16:09:30 Parsing trace... 
2017/09/17 16:09:30 Serializing trace... 
2017/09/17 16:09:30 Splitting trace... 
2017/09/17 16:09:30 Opening browser. Trace viewer is listening on http://127.0.0.1:60301
```
  

#### 5.9.4. æ¨¡æ‹Ÿè¿‡è½½

  

è®©æˆ‘ä»¬å°†è¯·æ±‚é€Ÿç‡å¢åŠ åˆ°æ¯ç§’5ä¸ªè¯·æ±‚ã€‚

  
```
% hey -c 5 -n 1000 -q 5 http://127.0.0.1:8080/mandelbrot
```
  

ç„¶ååœ¨å¦ä¸€ä¸ªçª—å£æ”¶é›†

  
```
% curl -o trace.out http://127.0.0.1:8080/debug/pprof/trace?seconds=5  
% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current Dload  Upload   Total   Spent    Left  Speed 100 66169    0 66169    0     0  13233      0 --:--:--  0:00:05 --:--:-- 17390 

% go tool trace trace.out 
2017/09/17 16:09:30 Parsing trace... 
2017/09/17 16:09:30 Serializing trace... 
2017/09/17 16:09:30 Splitting trace... 
2017/09/17 16:09:30 Opening browser. Trace viewer is listening on http://127.0.0.1:60301
```
  

  

#### 5.9.5. Extra credit, the Sieve of Eratosthenes

  

[å¹¶å‘ç­›é€‰è´¨æ•°](https://github.com/golang/go/blob/master/doc/play/sieve.go)æ˜¯æœ€æ—©ç¼–å†™çš„ Go ç¨‹åºä¹‹ä¸€ã€‚

  

Ivan Daniluk å†™äº†ä¸€ç¯‡å…³äºå¯è§†åŒ–çš„[æ–‡ç« ](https://divan.dev/posts/go_concurrency_visualize/)ã€‚

  

è®©æˆ‘ä»¬ä½¿ç”¨æ‰§è¡Œè·Ÿè¸ªç¨‹åºæ¥æŸ¥çœ‹å®ƒçš„æ“ä½œã€‚

  

#### 5.9.6. æ›´å¤šèµ„æ–™

  

*   Rhys Hiltner, [Goâ€™s execution tracer](https://www.youtube.com/watch?v=mmqDlbWk_XA) (dotGo 2016)

  

*   Rhys Hiltner, [An Introduction to "go tool trace"](https://www.youtube.com/watch?v=V74JnrGTwKA) (GopherCon 2017)

  

*   Dave Cheney, [Seven ways to profile Go programs](https://www.youtube.com/watch?v=2h_NFBFrciI) (GolangUK 2016)

  

*   Dave Cheney, [High performance Go workshop](https://dave.cheney.net/training#high-performance-go)\]

  

*   Ivan Daniluk, [Visualizing Concurrency in Go](https://www.youtube.com/watch?v=KyuFeiG3Y60) (GopherCon 2016)

  

*   Kavya Joshi, [Understanding Channels](https://www.youtube.com/watch?v=KBZlN0izeiY) (GopherCon 2017)

  

*   Francesc Campoy, [Using the Go execution tracer](https://www.youtube.com/watch?v=ySy3sR1LFCQ)

  

  
